<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">
<title>ARCA — Financial Intelligence</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700&family=Lora:ital,wght@0,600;1,400&display=swap" rel="stylesheet">
<style>
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
:root{
  /* Clean white + slate */
  --bg:#f8f9fa;
  --s1:#ffffff;
  --s2:#f1f3f5;
  --s3:#e9ecef;
  --s4:#dee2e6;
  --ln:#e2e8f0;
  --mid:#64748b;
  --dim:#94a3b8;
  --txt:#0f172a;
  --txt2:#334155;
  --acc:#2563eb;
  --accD:#1d4ed8;
  --accL:#eff6ff;
  --pos:#16a34a;
  --posL:#f0fdf4;
  --neg:#dc2626;
  --negL:#fff1f2;
  --gld:#d97706;
  --gldL:#fffbeb;
  --blu:#2563eb;
  --ff:'Plus Jakarta Sans',sans-serif;
  --fm:'Plus Jakarta Sans',sans-serif;
  --serif:'Lora',serif;
  --nav-h:60px;
  --radius:6px;
  --shadow:0 1px 2px rgba(15,23,42,.04),0 1px 3px rgba(15,23,42,.06);
  --shadow-md:0 4px 6px rgba(15,23,42,.04),0 10px 15px rgba(15,23,42,.06);
}
html,body{height:100%;background:var(--bg);color:var(--txt);font-family:var(--ff);font-size:13.5px;line-height:1.5;-webkit-font-smoothing:antialiased;-webkit-tap-highlight-color:transparent}
::-webkit-scrollbar{width:4px}::-webkit-scrollbar-track{background:var(--s2)}::-webkit-scrollbar-thumb{background:var(--ln);border-radius:2px}
::selection{background:var(--accL);color:var(--acc)}

/* ═══ LAYOUT ═══ */
.app{display:flex;height:100dvh;overflow:hidden}

/* ═══ SIDEBAR ═══ */
.sb{width:220px;flex-shrink:0;background:var(--s1);border-right:1px solid var(--ln);display:flex;flex-direction:column;overflow-y:auto;box-shadow:var(--shadow)}
.sb-brand{padding:22px 20px 18px;border-bottom:1px solid var(--ln)}
.sb-logo{font-family:var(--ff);font-size:15px;font-weight:700;letter-spacing:-.03em;color:var(--txt)}
.sb-user{font-size:11px;color:var(--mid);margin-top:3px;font-weight:400}
.sb-section{padding:14px 0 4px}
.sb-label{font-size:10px;letter-spacing:.12em;color:var(--dim);text-transform:uppercase;padding:0 18px 5px;font-weight:500}
.ni{display:flex;align-items:center;gap:9px;padding:7px 18px;font-size:13px;font-weight:400;color:var(--txt2);cursor:pointer;border:none;background:none;width:100%;text-align:left;transition:all .12s;border-radius:0;letter-spacing:0}
.ni:hover{color:var(--txt);background:var(--s2)}
.ni.on{color:var(--acc);background:var(--accL);font-weight:500}
.ni-dot{width:4px;height:4px;border-radius:50%;background:currentColor;flex-shrink:0;opacity:.4}
.ni.on .ni-dot{opacity:1}
.sb-household{padding:14px 18px 18px;border-top:1px solid var(--ln);margin-top:auto}
.sb-hh-label{font-size:10px;letter-spacing:.1em;color:var(--dim);text-transform:uppercase;margin-bottom:8px;font-weight:500}
.sb-hh-members{display:flex;flex-direction:column;gap:4px}
.hh-member{display:flex;align-items:center;gap:8px;padding:5px 8px;border-radius:4px;cursor:pointer;transition:background .1s}
.hh-member:hover{background:var(--s2)}
.hh-member.active-user{background:var(--accL)}
.hh-avatar{width:24px;height:24px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:9px;font-weight:600;flex-shrink:0;letter-spacing:.02em}
.hh-name{font-size:12px;color:var(--txt2);font-weight:400}
.hh-member.active-user .hh-name{color:var(--acc);font-weight:500}

/* ═══ MAIN ═══ */
.main{flex:1;overflow-y:auto;background:var(--bg)}
.pg{display:none}
.pg.on{display:block;animation:pgIn .15s ease}
@keyframes pgIn{from{opacity:0;transform:translateY(4px)}to{opacity:1;transform:translateY(0)}}

/* ═══ PAGE HEADER ═══ */
.ph{padding:28px 32px 20px;border-bottom:1px solid var(--ln);display:flex;align-items:flex-end;justify-content:space-between;gap:16px;background:var(--s1)}
.ph-left{}
.ph-eyebrow{font-size:10px;letter-spacing:.12em;color:var(--dim);text-transform:uppercase;margin-bottom:6px;font-weight:500}
.ph-title{font-family:var(--ff);font-size:21px;font-weight:700;letter-spacing:-.03em}
.ph-actions{display:flex;gap:8px;flex-shrink:0}
.pc{padding:24px 32px 60px}

/* ═══ BUTTONS ═══ */
.btn{display:inline-flex;align-items:center;gap:6px;font-family:var(--ff);font-size:12px;font-weight:500;letter-spacing:.03em;cursor:pointer;border:none;transition:all .12s;white-space:nowrap;border-radius:3px}
.btn-acc{background:var(--acc);color:#fff;padding:8px 16px}
.btn-acc:hover{background:var(--accD)}
.btn-out{background:transparent;color:var(--txt2);padding:8px 14px;border:1px solid var(--ln)}
.btn-out:hover{border-color:var(--acc);color:var(--acc)}
.btn-ghost{background:transparent;color:var(--mid);padding:6px 10px;border:1px solid var(--ln);font-size:11px}
.btn-ghost:hover{color:var(--txt);border-color:var(--txt2);background:var(--s2)}

/* ═══ STAT CARDS ═══ */
.grid{display:grid;gap:1px;background:var(--ln);border:1px solid var(--ln);margin-bottom:24px}
.g4{grid-template-columns:repeat(4,1fr)}
.g3{grid-template-columns:repeat(3,1fr)}
.g2{grid-template-columns:repeat(2,1fr)}
.stat{background:var(--s1);padding:20px 22px}
.stat-label{font-size:10px;letter-spacing:.1em;text-transform:uppercase;color:var(--mid);margin-bottom:10px;font-weight:500}
.stat-val{font-family:var(--ff);font-size:22px;font-weight:700;letter-spacing:-.04em;line-height:1}
.stat-val.pos{color:var(--pos)}
.stat-val.neg{color:var(--neg)}
.stat-val.acc{color:var(--acc)}
.stat-val.gld{color:var(--gld)}
.stat-val.blu{color:var(--blu)}
.stat-sub{font-size:10.5px;color:var(--dim);margin-top:6px}

/* ═══ PANELS ═══ */
.panel{background:var(--s1);border:1px solid var(--ln);margin-bottom:1px}
.panel+.panel{border-top:none;box-shadow:none}
.panel-hd{padding:14px 20px;border-bottom:1px solid var(--ln);display:flex;align-items:center;justify-content:space-between}
.panel-title{font-size:10.5px;letter-spacing:.1em;text-transform:uppercase;color:var(--mid);font-weight:500}
.panel-body{padding:20px}

/* ═══ TABLE ═══ */
.tbl{width:100%;border-collapse:collapse}
.tbl th{font-size:10px;letter-spacing:.1em;text-transform:uppercase;color:var(--dim);padding:10px 16px;text-align:left;border-bottom:1px solid var(--ln);font-weight:500;background:var(--s2)}
.tbl td{padding:11px 16px;font-size:12.5px;border-bottom:1px solid var(--s3);color:var(--txt2)}
.tbl tr:last-child td{border-bottom:none}
.tbl tbody tr{transition:background .1s}
.tbl tbody tr:hover{background:var(--s2)}
.tr{text-align:right}
.tbl td.pos{color:var(--pos)}.tbl td.neg{color:var(--neg)}.tbl td.gld{color:var(--gld)}

/* ═══ TAGS ═══ */
.tag{display:inline-block;font-size:9.5px;letter-spacing:.08em;text-transform:uppercase;padding:2px 6px;border-radius:2px;font-weight:500}
.tag-g{background:var(--posL);color:var(--pos)}
.tag-r{background:var(--negL);color:var(--neg)}
.tag-y{background:var(--gldL);color:var(--gld)}
.tag-b{background:var(--accL);color:var(--acc)}
.tag-d{background:var(--s3);color:var(--mid)}

/* ═══ BAR CHART ═══ */
.barchart{display:flex;align-items:flex-end;gap:4px;height:90px}
.barpair{display:flex;gap:1px;align-items:flex-end;flex:1}
.bar{flex:1;min-width:4px;border-radius:1px 1px 0 0}
.blbl{font-size:9px;color:var(--dim);text-align:center;margin-top:5px;letter-spacing:.04em}

/* ═══ LINE CHART ═══ */
.linechart{height:70px;position:relative}

/* ═══ PROGRESS ═══ */
.prog{height:3px;background:var(--s3);overflow:hidden;margin-top:8px;border-radius:2px}
.progf{height:100%;border-radius:2px}

/* ═══ ROW LIST ═══ */
.rlist{background:var(--s1);border:1px solid var(--ln)}
.rrow{padding:12px 18px;border-bottom:1px solid var(--s3);display:flex;align-items:center;justify-content:space-between;transition:background .1s}
.rrow:last-child{border-bottom:none}
.rrow:hover{background:var(--s2)}
.rrow-l{flex:1;min-width:0}
.rrow-name{font-weight:500;font-size:13.5px;letter-spacing:-.01em;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;color:var(--txt)}
.rrow-sub{font-size:11px;color:var(--mid);margin-top:2px;display:flex;gap:8px;align-items:center}
.rrow-r{text-align:right;flex-shrink:0;margin-left:16px}
.rrow-amt{font-size:13.5px;font-weight:600;font-family:var(--ff);letter-spacing:-.02em}
.rrow-sub2{font-size:10px;color:var(--dim);margin-top:2px}

/* ═══ TABS ═══ */
.tabs{display:flex;border-bottom:1px solid var(--ln);margin-bottom:20px}
.tab{font-size:11px;letter-spacing:.08em;text-transform:uppercase;padding:10px 18px;cursor:pointer;border:none;background:none;color:var(--dim);border-bottom:2px solid transparent;margin-bottom:-1px;transition:all .12s;font-weight:500}
.tab:hover{color:var(--txt2)}
.tab.on{color:var(--acc);border-bottom-color:var(--acc)}

/* ═══ WATERFALL ═══ */
.wfr{display:flex;justify-content:space-between;padding:9px 0;border-bottom:1px solid var(--s3);font-size:13px}
.wft{display:flex;justify-content:space-between;padding:10px 0;border-top:1px solid var(--ln);font-size:13.5px;font-weight:600}

/* ═══ CHAT ═══ */
.chatbox{height:300px;overflow-y:auto;display:flex;flex-direction:column;gap:14px;padding:4px 0 8px}
.msg{display:flex;gap:10px;align-items:flex-start}
.msg.u{flex-direction:row-reverse}
.ava{width:28px;height:28px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:10px;letter-spacing:.05em;flex-shrink:0;font-weight:600;background:var(--s3);color:var(--mid);border:1px solid var(--ln)}
.ava.acc{background:var(--acc);color:#fff;border-color:var(--acc)}
.bub{padding:10px 14px;font-size:13px;line-height:1.6;max-width:80%;border-radius:4px}
.bub.a{background:var(--s1);border:1px solid var(--ln);color:var(--txt2);box-shadow:var(--shadow)}
.bub.u{background:var(--acc);color:#fff}
.scnote{margin-top:10px;padding:9px 12px;border-left:2px solid var(--acc);background:var(--accL);font-size:11px;color:var(--acc);border-radius:0 3px 3px 0}
.chatrow{display:flex;gap:8px;align-items:stretch;padding-top:14px;border-top:1px solid var(--ln);margin-top:12px}
.chatinp{flex:1;background:var(--s1);border:1px solid var(--ln);color:var(--txt);font-family:var(--ff);font-size:13px;padding:10px 14px;outline:none;resize:none;height:44px;border-radius:3px 0 0 3px}
.chatinp:focus{border-color:var(--acc)}
.chatinp::placeholder{color:var(--dim)}
.chatsend{background:var(--acc);color:#fff;border:none;width:44px;font-size:18px;cursor:pointer;font-weight:600;display:flex;align-items:center;justify-content:center;flex-shrink:0;border-radius:0 3px 3px 0}
.chatsend:hover{background:var(--accD)}

/* ═══ FORM ═══ */
.finp{background:var(--s1);border:1px solid var(--ln);color:var(--txt);font-family:var(--ff);font-size:13px;padding:9px 12px;outline:none;width:100%;border-radius:3px;transition:border-color .12s}
.finp:focus{border-color:var(--acc);box-shadow:0 0 0 3px var(--accL)}
.finp::placeholder{color:var(--dim)}
select.finp{cursor:pointer}
.flbl{font-size:10.5px;letter-spacing:.06em;text-transform:uppercase;color:var(--mid);display:block;margin-bottom:6px;font-weight:500}
.fgrp{margin-bottom:16px}
.fg2{display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-bottom:16px}

/* ═══ MODALS ═══ */
.mo{display:none;position:fixed;inset:0;z-index:200;background:rgba(26,24,20,.4);backdrop-filter:blur(3px);align-items:flex-end;justify-content:center}
.mo.open{display:flex;animation:mofade .15s ease}
@keyframes mofade{from{opacity:0}to{opacity:1}}
@media(min-width:701px){.mo{align-items:center}.hh-desktop-note{display:inline !important}}
.mbox{background:var(--s1);border:1px solid var(--ln);width:100%;max-width:520px;padding:0;max-height:90dvh;overflow-y:auto;animation:moSlide .18s ease;border-radius:6px;box-shadow:var(--shadow-md)}
@keyframes moSlide{from{transform:translateY(16px);opacity:0}to{transform:translateY(0);opacity:1}}
.mhd{padding:20px 24px;border-bottom:1px solid var(--ln);display:flex;align-items:center;justify-content:space-between}
.mtitle{font-family:var(--ff);font-size:15px;font-weight:600;letter-spacing:-.02em}
.mclose{background:none;border:none;color:var(--mid);font-size:18px;cursor:pointer;padding:2px 6px;line-height:1;border-radius:3px}
.mclose:hover{color:var(--txt);background:var(--s2)}
.mbody{padding:24px}
.mactions{display:flex;gap:8px;padding:16px 24px;border-top:1px solid var(--ln);background:var(--s2);border-radius:0 0 6px 6px}
.mactions .btn{flex:1;justify-content:center;padding:11px}
.flash{margin-top:14px;padding:10px 14px;border-left:2px solid var(--pos);background:var(--posL);font-size:11.5px;color:var(--pos);display:none;letter-spacing:.02em;border-radius:0 3px 3px 0}
.flash.on{display:block}
.preview-box{margin-top:8px;padding:10px 14px;border-left:2px solid var(--acc);background:var(--accL);font-size:11px;color:var(--acc);display:none;border-radius:0 3px 3px 0}
.preview-box.on{display:block}
.clr-opts{display:flex;gap:8px;padding-top:4px}
.clr-swatch{width:22px;height:22px;cursor:pointer;border:2px solid transparent;transition:all .12s;border-radius:50%}
.clr-swatch.on{border-color:var(--txt);transform:scale(1.15);box-shadow:0 0 0 3px var(--s3)}

/* ═══ LOAN CARD ═══ */
.lcard{background:var(--s1);border:1px solid var(--ln);margin-bottom:8px;padding:22px 24px;border-radius:var(--radius)}

/* ═══ MOBILE HEADER ═══ */
.mob-hd{display:none;position:fixed;top:0;left:0;right:0;z-index:100;background:var(--s1);border-bottom:1px solid var(--ln);height:50px;padding:0 16px;align-items:center;justify-content:space-between;box-shadow:var(--shadow)}
.mob-logo{font-family:var(--ff);font-weight:700;font-size:14px;letter-spacing:-.03em}
.mob-title{font-size:11px;letter-spacing:.1em;color:var(--mid);text-transform:uppercase;font-weight:500}

/* ═══ MOBILE NAV ═══ */
.mob-nav{display:none;position:fixed;bottom:0;left:0;right:0;z-index:100;background:var(--s1);border-top:1px solid var(--ln);height:var(--nav-h);align-items:stretch;box-shadow:0 -1px 4px rgba(26,24,20,.06)}
.mnb{display:flex;flex-direction:column;align-items:center;justify-content:center;gap:3px;flex:1;border:none;background:none;cursor:pointer;font-size:9px;letter-spacing:.08em;text-transform:uppercase;color:var(--mid);border-top:2px solid transparent;transition:all .12s;font-weight:500}
.mnb.on{color:var(--acc);border-top-color:var(--acc)}
.mnb-ic{font-size:14px;font-weight:700;line-height:1}

/* ═══ MORE DRAWER ═══ */
.drawer-ov{display:none;position:fixed;inset:0;z-index:98;background:rgba(26,24,20,.35)}
.drawer-ov.open{display:block}
.more-drawer{display:none;position:fixed;bottom:var(--nav-h);left:0;right:0;z-index:99;background:var(--s1);border-top:1px solid var(--ln);padding:16px;box-shadow:var(--shadow-md)}
.more-drawer.open{display:block}
.mdb-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:8px}
.mdb{display:flex;flex-direction:column;align-items:center;gap:5px;padding:14px 6px;border:1px solid var(--ln);background:var(--s1);cursor:pointer;font-size:9.5px;letter-spacing:.06em;text-transform:uppercase;color:var(--mid);transition:all .12s;border-radius:4px;font-weight:500}
.mdb:hover,.mdb.on{background:var(--accL);color:var(--acc);border-color:var(--acc)}
.mdb-ic{font-size:11px;font-weight:700}

/* ═══ UPLOAD DZ ═══ */
.dz{border:2px dashed var(--ln);padding:48px 32px;text-align:center;cursor:pointer;transition:all .15s;border-radius:6px}
.dz:hover{border-color:var(--acc);background:var(--accL)}
.dz-icon{font-family:var(--ff);font-size:26px;font-weight:700;color:var(--dim);margin-bottom:12px;letter-spacing:-.04em}
.dz-title{font-weight:500;font-size:14px;margin-bottom:4px;color:var(--txt)}
.dz-sub{font-size:11.5px;color:var(--mid)}

/* ═══ AUTH ═══ */
.auth-wrap{display:flex;align-items:center;justify-content:center;min-height:80dvh;padding:24px}
.auth-box{width:100%;max-width:380px;background:var(--s1);border:1px solid var(--ln);border-radius:6px;box-shadow:var(--shadow-md)}
.auth-hd{padding:32px 32px 24px;border-bottom:1px solid var(--ln)}
.auth-body{padding:28px 32px 24px}
.auth-ft{padding:16px 32px 20px;border-top:1px solid var(--ln);background:var(--s2);border-radius:0 0 6px 6px}
.auth-logo{font-family:var(--ff);font-size:19px;font-weight:700;margin-bottom:4px;letter-spacing:-.04em}
.auth-sub{font-size:11px;color:var(--mid);letter-spacing:.04em}
.pwd-strength{display:flex;gap:3px;margin-top:8px}
.pwd-bar{flex:1;height:3px;border-radius:2px}
.pwd-label{font-size:9.5px;color:var(--pos);margin-top:5px;letter-spacing:.06em}
.strengths{display:flex;gap:12px;margin-top:5px;flex-wrap:wrap}
.stchk{font-size:10px;color:var(--pos)}

/* ═══ HOUSEHOLD SECTION ═══ */
.hh-banner{padding:10px 16px;background:var(--accL);border:1px solid var(--acc);border-left-width:3px;margin-bottom:16px;border-radius:0 3px 3px 0;font-size:11px;color:var(--acc);font-weight:500;letter-spacing:.03em}
.hh-card{background:var(--s1);border:1px solid var(--ln);border-radius:4px;box-shadow:var(--shadow)}
.hh-split{display:grid;grid-template-columns:1fr 1fr;gap:1px;background:var(--ln);border:1px solid var(--ln);border-radius:4px;overflow:hidden;box-shadow:var(--shadow)}
.hh-col{background:var(--s1)}
.hh-col-hd{padding:14px 18px;border-bottom:1px solid var(--ln);display:flex;align-items:center;gap:10px}
.hh-col-name{font-weight:600;font-size:13.5px;color:var(--txt)}
.hh-col-sub{font-size:10.5px;color:var(--mid);margin-top:1px}

/* ═══ RESPONSIVE ═══ */
@media(max-width:700px){
  /* Profile page two-col → single col */
  .prof-two-col{grid-template-columns:1fr !important}
  /* Conversion table 4-col → 2-col */
  .conv-table-4{grid-template-columns:repeat(2,1fr) !important}
  /* More drawer 4-col → 3-col on small screens */
  .mdb-grid{grid-template-columns:repeat(3,1fr) !important}

  .sb{display:none}
  .mob-hd{display:flex}
  .mob-nav{display:flex}
  .main{padding-top:50px;padding-bottom:var(--nav-h)}
  .ph{padding:16px 16px 14px;flex-direction:column;align-items:flex-start;gap:10px;background:var(--s1)}
  .pc{padding:16px 16px 40px}
  .g4{grid-template-columns:1fr 1fr}
  .g3{grid-template-columns:1fr 1fr}
  .g2{grid-template-columns:1fr}
  .tabs{overflow-x:auto;white-space:nowrap}
  .chatbox{height:220px}
  .bub{max-width:90%}
  .fg2{grid-template-columns:1fr}
  .lcard{padding:16px}
  .tbl th:nth-child(3),.tbl td:nth-child(3){display:none}
  .tbl th:nth-child(4),.tbl td:nth-child(4){display:none}
  .hh-split{grid-template-columns:1fr}
}

@keyframes pulse{0%,80%,100%{opacity:.25;transform:scale(.7)}40%{opacity:1;transform:scale(1)}}

/* UPLOAD LOG */
.ul-row-flagged td{background:var(--negL) !important}
.ul-row-flagged .ul-fname{color:var(--neg)}
.ul-confirm{display:none;background:var(--negL);border-top:1px solid var(--neg)}
.ul-confirm.open{display:table-row}
.ul-confirm td{padding:12px 16px !important;border-bottom:1px solid var(--ln) !important}
.ul-del-btn{padding:5px 14px;font-size:11px;font-weight:600;letter-spacing:.04em;border-radius:3px;cursor:pointer;border:none;transition:all .12s}
.ul-del-confirm{background:var(--neg);color:#fff}.ul-del-confirm:hover{background:#b91c1c}
.ul-del-cancel{background:var(--s3);color:var(--txt2);margin-left:8px}.ul-del-cancel:hover{background:var(--s4)}
.ul-flag-btn{padding:4px 10px;font-size:10.5px;font-weight:500;letter-spacing:.03em;border-radius:3px;cursor:pointer;border:1px solid var(--gld);color:var(--gld);background:transparent;transition:all .12s}
.ul-flag-btn:hover{background:var(--gldL)}
.ul-flag-btn.flagged{background:var(--gldL);color:var(--gld)}

/* BILLING CYCLE */
.cc-timeline{display:flex;align-items:center;margin:16px 0;position:relative}
.cc-tnode{display:flex;flex-direction:column;align-items:center;gap:4px;flex-shrink:0}
.cc-tnode-dot{width:10px;height:10px;border-radius:50%;border:2px solid currentColor}
.cc-tnode-label{font-size:9.5px;letter-spacing:.08em;text-transform:uppercase;font-weight:600}
.cc-tnode-date{font-size:11px;color:var(--txt2)}
.cc-tline{flex:1;height:2px;background:var(--ln);margin:0 8px;position:relative;top:-10px}
.cc-tline-fill{height:100%;border-radius:1px;transition:width .4s ease}
.cc-card-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:1px;background:var(--ln);border:1px solid var(--ln);border-radius:var(--radius);overflow:hidden;margin:16px 0}
.cc-card{background:var(--s1);padding:14px 18px}
.cc-card-label{font-size:9.5px;text-transform:uppercase;letter-spacing:.1em;color:var(--dim);margin-bottom:6px;font-weight:500}
.cc-card-val{font-size:16px;font-weight:700;letter-spacing:-.02em}

/* FORECAST MONTH DETAIL */
.fc-expand-btn{background:none;border:none;cursor:pointer;color:var(--dim);font-size:11px;padding:2px 6px;transition:color .1s;line-height:1;border-radius:2px}
.fc-expand-btn:hover,.fc-expand-btn.open{color:var(--acc);background:var(--accL)}
.fc-detail-row td{padding:0 !important;border-bottom:none !important}
.fc-detail{overflow:hidden;max-height:0;transition:max-height .28s ease}
.fc-detail.open{max-height:900px}
.fc-detail-inner{padding:0 0 0 36px;background:var(--s2);border-bottom:1px solid var(--ln)}
.fc-cat-row{display:flex;align-items:center;padding:7px 20px 7px 0;border-bottom:1px solid var(--s3)}
.fc-cat-row:last-child{border-bottom:none}
.fc-cat-dot{width:6px;height:6px;border-radius:50%;flex-shrink:0;margin-right:10px}
.fc-cat-name{font-size:12px;color:var(--txt2);flex:1;letter-spacing:0}
.fc-cat-bar-wrap{width:100px;height:3px;background:var(--s4);margin-right:14px;flex-shrink:0;border-radius:2px}
.fc-cat-bar{height:100%;border-radius:2px}
.fc-cat-amt{font-size:12px;font-weight:500;width:72px;text-align:right;flex-shrink:0;color:var(--txt2)}
.fc-inc-row{display:flex;justify-content:space-between;align-items:center;padding:7px 20px 7px 0;border-bottom:1px solid var(--s3)}
.fc-section-hd{font-size:9.5px;letter-spacing:.1em;text-transform:uppercase;color:var(--mid);padding:10px 20px 6px 0;font-weight:500}
@keyframes tick{from{opacity:0;transform:translateX(-4px)}to{opacity:1;transform:translateX(0)}}

/* ═══ UPLOAD LOG ═══ */
.ul-confirm{display:none;background:var(--negL)}
.ul-confirm.open{display:table-row}
.ul-confirm td{padding:10px 18px !important;border-bottom:1px solid var(--neg) !important}
.ul-row-flagged{background:var(--gldL)}
.ul-flag-btn{background:none;border:1px solid var(--ln);color:var(--mid);font-size:11px;padding:4px 10px;border-radius:3px;cursor:pointer;font-weight:500;margin-right:6px;transition:all .12s}
.ul-flag-btn:hover{border-color:var(--gld);color:var(--gld)}
.ul-flag-btn.flagged{border-color:var(--gld);color:var(--gld);background:var(--gldL)}
.ul-del-btn{font-size:11px;padding:5px 12px;border-radius:3px;cursor:pointer;font-weight:500;border:1px solid}
.ul-del-confirm{background:var(--neg);color:#fff;border-color:var(--neg)}
.ul-del-cancel{background:none;color:var(--mid);border-color:var(--ln)}
.del-btn{background:none;border:1px solid var(--ln);color:var(--mid);font-size:11px;padding:4px 10px;border-radius:3px;cursor:pointer;font-weight:500}
.del-btn:hover{border-color:var(--neg);color:var(--neg)}

/* ═══ BILLING CYCLE ═══ */
#cc-cycle-banner{transition:all .2s}

</style>
</head>
<body>

<!--
  ╔══════════════════════════════════════════════════════════════════════════╗
  ║  AUTH GATE — PRODUCTION ARCHITECTURE NOTE                                ║
  ║                                                                           ║
  ║  In production this #auth-gate sits BEFORE the #app shell in the DOM.   ║
  ║  On page load, only #auth-gate is visible; #app is hidden.               ║
  ║                                                                           ║
  ║  Flow:                                                                    ║
  ║    1. User lands on the page → sees only the sign-in screen               ║
  ║    2. POST /api/auth/login → server returns JWT                           ║
  ║    3. Store JWT in httpOnly cookie (server-side) or memory (client-side)  ║
  ║    4. hideAuthGate() → fade out gate, reveal #app                        ║
  ║    5. On subsequent visits, validate cookie/token server-side            ║
  ║       before serving the page — skip the gate entirely                   ║
  ║                                                                           ║
  ║  In this PREVIEW the "Sign In" button calls previewSignIn() which        ║
  ║  simply hides the gate so you can explore the app.                       ║
  ╚══════════════════════════════════════════════════════════════════════════╝
-->
<div id="auth-gate" style="
  position:fixed;inset:0;z-index:9999;
  background:var(--bg);
  display:flex;align-items:center;justify-content:center;
  padding:24px;
  transition:opacity .3s ease;
">
  <div class="auth-box" style="width:100%;max-width:380px">
    <div class="auth-hd">
      <div class="auth-logo">Arca</div>
      <div class="auth-sub">Private financial intelligence — Secure access</div>
    </div>
    <div class="auth-body">
      <div style="display:flex;margin-bottom:20px;border:1px solid var(--ln);border-radius:var(--radius);overflow:hidden">
        <button id="auth-tab-in"  onclick="authTab('in')"  style="flex:1;padding:9px;font-size:11px;font-weight:600;letter-spacing:.06em;text-transform:uppercase;border:none;cursor:pointer;background:var(--acc);color:#fff;transition:all .12s">Sign In</button>
        <button id="auth-tab-up"  onclick="authTab('up')"  style="flex:1;padding:9px;font-size:11px;font-weight:600;letter-spacing:.06em;text-transform:uppercase;border:none;cursor:pointer;background:transparent;color:var(--mid);transition:all .12s">Register</button>
      </div>
      <div class="fgrp">
        <label class="flbl">Email Address</label>
        <input class="finp" id="auth-email" type="email" value="garcia@example.com" placeholder="you@example.com">
      </div>
      <div class="fgrp">
        <label class="flbl">Password</label>
        <input class="finp" id="auth-pass" type="password" value="Secure123!" placeholder="Password">
        <div class="pwd-strength" style="margin-top:8px">
          <div class="pwd-bar" style="background:var(--pos)"></div>
          <div class="pwd-bar" style="background:var(--pos)"></div>
          <div class="pwd-bar" style="background:var(--pos)"></div>
          <div class="pwd-bar" style="background:var(--s3)"></div>
        </div>
        <div class="pwd-label">Strong</div>
      </div>
    </div>
    <div class="auth-ft">
      <!-- PREVIEW: calls previewSignIn(). Production: submit to /api/auth/login -->
      <button class="btn btn-acc" onclick="previewSignIn()" style="width:100%;justify-content:center;padding:12px;font-size:13px;border-radius:var(--radius)">Sign In</button>
      <div style="font-size:11px;color:var(--dim);text-align:center;margin-top:14px;line-height:1.6">
        This is a <strong style="color:var(--acc)">preview</strong> — click Sign In to explore the app.
        <br>In production, credentials are verified server-side before access is granted.
      </div>
    </div>
  </div>
</div>

<div class="app">

<!-- ═══ SIDEBAR ═══ -->
<nav class="sb">
  <div class="sb-brand">
    <div class="sb-logo">Arca</div>
    <div class="sb-user" id="sb-user-label">GARCIA, JORGE / GTM</div>
  </div>

  <div class="sb-section">
    <div class="sb-label">Overview</div>
    <button class="ni on" onclick="go('dashboard',this,'Dashboard')"><span class="ni-dot"></span>Dashboard</button>
    <button class="ni" onclick="go('networth',this,'Net Worth')"><span class="ni-dot"></span>Net Worth</button>
  </div>

  <div class="sb-section">
    <div class="sb-label">Flows</div>
    <button class="ni" onclick="go('upload',this,'Import Statement')"><span class="ni-dot"></span>Import Statement</button>
    <button class="ni" onclick="go('cash',this,'Cash Ledger')"><span class="ni-dot"></span>Cash Ledger</button>
    <button class="ni" onclick="go('txns',this,'Transactions')"><span class="ni-dot"></span>Transactions</button>
  </div>

  <div class="sb-section">
    <div class="sb-label">Planning</div>
    <button class="ni" onclick="go('forecast',this,'Forecast')"><span class="ni-dot"></span>Forecast</button>
    <button class="ni" onclick="go('scenarios',this,'Scenario Modeling')"><span class="ni-dot"></span>Scenario Modeling</button>
    <button class="ni" onclick="go('loans',this,'Liabilities')"><span class="ni-dot"></span>Liabilities</button>
  </div>

  <div class="sb-section">
    <div class="sb-label">Assets</div>
    <button class="ni" onclick="go('investments',this,'Portfolio')"><span class="ni-dot"></span>Portfolio</button>
  </div>

  <div class="sb-section">
    <div class="sb-label">Control</div>
    <button class="ni" onclick="go('recon',this,'Reconciliation')"><span class="ni-dot"></span>Reconciliation</button>
    <button class="ni" onclick="go('reports',this,'Annual Report')"><span class="ni-dot"></span>Annual Report</button>
    <button class="ni" onclick="go('cats',this,'Categories')"><span class="ni-dot"></span>Categories</button>
    <button class="ni" onclick="go('profile',this,'User Profile')"><span class="ni-dot"></span>User Profile</button>
    <button class="ni" onclick="go('household',this,'Household')"><span class="ni-dot"></span>Household</button>
  </div>

  <!-- Household members widget -->
  <div class="sb-household">
    <div class="sb-hh-label">Household</div>
    <div class="sb-hh-members" id="sb-hh-members"></div>
  </div>
</nav>

<!-- ═══ MOBILE HEADER ═══ -->
<div class="mob-hd">
  <div class="mob-logo">Arca</div>
  <div class="mob-title" id="mob-title">Dashboard</div>
  <div style="font-family:var(--fm);font-size:9.5px;color:var(--acc)">PRV</div>
</div>

<!-- ═══ MOBILE NAV ═══ -->
<div class="mob-nav">
  <button class="mnb on" onclick="go('dashboard',this,'Dashboard')"><span class="mnb-ic">--</span>Home</button>
  <button class="mnb" onclick="go('txns',this,'Transactions')"><span class="mnb-ic">::</span>Txns</button>
  <button class="mnb" onclick="go('scenarios',this,'Scenarios')"><span class="mnb-ic">[]</span>Model</button>
  <button class="mnb" onclick="go('investments',this,'Portfolio')"><span class="mnb-ic">/\</span>Port.</button>
  <button class="mnb" onclick="toggleMore()"><span class="mnb-ic">...</span>More</button>
</div>
<div class="drawer-ov" id="dov" onclick="closeMore()"></div>
<div class="more-drawer" id="mdrawer">
  <div style="font-size:10px;letter-spacing:.12em;text-transform:uppercase;color:var(--dim);font-weight:500;margin-bottom:10px;padding:0 2px">All Pages</div>
  <div class="mdb-grid">
    <button class="mdb" onclick="go('networth',null,'Net Worth');closeMore()"><span class="mdb-ic">NW</span>Net Worth</button>
    <button class="mdb" onclick="go('upload',null,'Import');closeMore()"><span class="mdb-ic">UP</span>Import</button>
    <button class="mdb" onclick="go('cash',null,'Cash');closeMore()"><span class="mdb-ic">CS</span>Cash</button>
    <button class="mdb" onclick="go('forecast',null,'Forecast');closeMore()"><span class="mdb-ic">FC</span>Forecast</button>
    <button class="mdb" onclick="go('loans',null,'Liabilities');closeMore()"><span class="mdb-ic">LB</span>Liabilities</button>
    <button class="mdb" onclick="go('recon',null,'Reconciliation');closeMore()"><span class="mdb-ic">RC</span>Recon</button>
    <button class="mdb" onclick="go('reports',null,'Report');closeMore()"><span class="mdb-ic">AR</span>Report</button>
    <button class="mdb" onclick="go('cats',null,'Categories');closeMore()"><span class="mdb-ic">CT</span>Categories</button>
    <button class="mdb" onclick="go('household',null,'Household');closeMore()"><span class="mdb-ic">HH</span>Household</button>
    <button class="mdb" onclick="go('profile',null,'User Profile');closeMore()"><span class="mdb-ic">ME</span>Profile</button>
  </div>
</div>

<main class="main">

<!-- ══ DASHBOARD ══ -->
<div id="dashboard" class="pg on">
  <div class="ph">
    <div class="ph-left">
      <div class="ph-eyebrow">Mon 23 Feb 2026 — FY2026</div>
      <div class="ph-title">Dashboard</div>
    </div>
  </div>
  <div class="pc">
    <div class="grid g4" style="margin-bottom:24px">
      <div class="stat"><div class="stat-label">Year-End Projection</div><div class="stat-val acc">$18,240</div><div class="stat-sub">Cumulative net balance</div></div>
      <div class="stat"><div class="stat-label">Feb Expenses</div><div class="stat-val neg">$4,182</div><div class="stat-sub">Actual MTD</div></div>
      <div class="stat"><div class="stat-label">Feb Income</div><div class="stat-val pos">$7,500</div><div class="stat-sub">Scheduled</div></div>
      <div class="stat"><div class="stat-label">Net Feb</div><div class="stat-val pos">+$3,318</div><div class="stat-sub">After all expenses</div></div>
    </div>

    <div style="display:grid;grid-template-columns:1.2fr 1fr;gap:1px;background:var(--ln);border:1px solid var(--ln);margin-bottom:24px">
      <div style="background:var(--s1);padding:20px">
        <div style="font-family:var(--fm);font-size:9.5px;letter-spacing:.16em;text-transform:uppercase;color:var(--mid);margin-bottom:16px">Income vs Expenses — FY2026</div>
        <div class="barchart">
          <div style="flex:1"><div class="barpair"><div class="bar" style="height:80px;background:var(--pos);opacity:.25"></div><div class="bar" style="height:54px;background:var(--neg);opacity:.3"></div></div><div class="blbl">JAN</div></div>
          <div style="flex:1"><div class="barpair"><div class="bar" style="height:80px;background:var(--pos);opacity:.6"></div><div class="bar" style="height:46px;background:var(--neg);opacity:.6"></div></div><div class="blbl">FEB</div></div>
          <div style="flex:1;opacity:.3"><div class="barpair"><div class="bar" style="height:80px;background:var(--pos)"></div><div class="bar" style="height:56px;background:var(--neg)"></div></div><div class="blbl">MAR</div></div>
          <div style="flex:1;opacity:.2"><div class="barpair"><div class="bar" style="height:80px;background:var(--pos)"></div><div class="bar" style="height:50px;background:var(--neg)"></div></div><div class="blbl">APR</div></div>
          <div style="flex:1;opacity:.15"><div class="barpair"><div class="bar" style="height:80px;background:var(--pos)"></div><div class="bar" style="height:53px;background:var(--neg)"></div></div><div class="blbl">MAY</div></div>
          <div style="flex:1;opacity:.12"><div class="barpair"><div class="bar" style="height:80px;background:var(--pos)"></div><div class="bar" style="height:59px;background:var(--neg)"></div></div><div class="blbl">JUN</div></div>
        </div>
        <div style="display:flex;gap:16px;margin-top:12px">
          <span style="font-family:var(--fm);font-size:9.5px;color:var(--dim)"><span style="display:inline-block;width:8px;height:2px;background:var(--pos);margin-right:5px;vertical-align:middle"></span>Income</span>
          <span style="font-family:var(--fm);font-size:9.5px;color:var(--dim)"><span style="display:inline-block;width:8px;height:2px;background:var(--neg);margin-right:5px;vertical-align:middle"></span>Expenses</span>
          <span style="font-family:var(--fm);font-size:9.5px;color:var(--dim)">Opacity = confidence</span>
        </div>
      </div>
      <div style="background:var(--s1);padding:20px">
        <div style="font-family:var(--fm);font-size:9.5px;letter-spacing:.16em;text-transform:uppercase;color:var(--mid);margin-bottom:16px">Cumulative Balance Trajectory</div>
        <div class="linechart">
          <svg width="100%" height="70" viewBox="0 0 300 70" preserveAspectRatio="none">
            <defs><linearGradient id="lg" x1="0" y1="0" x2="0" y2="1"><stop offset="0%" stop-color="#c8f542" stop-opacity=".12"/><stop offset="100%" stop-color="#c8f542" stop-opacity="0"/></linearGradient></defs>
            <polygon points="0,54 40,48 80,52 120,36 160,28 220,18 300,14 300,70 0,70" fill="url(#lg)"/>
            <polyline points="0,54 40,48 80,52 120,36 160,28 220,18 300,14" fill="none" stroke="#c8f542" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
            <circle cx="220" cy="18" r="3" fill="#c8f542"/>
          </svg>
        </div>
        <div style="display:flex;justify-content:space-between;font-family:var(--fm);font-size:9px;color:var(--dim);margin-top:6px"><span>JAN</span><span>MAR</span><span>JUN</span><span>SEP</span><span>DEC</span></div>
      </div>
    </div>

    <div class="panel">
      <div class="panel-hd"><div class="panel-title">Top Expenditure — Feb 2026</div></div>
      <div id="dash-cats" style="padding:0"></div>
    </div>
  </div>
</div>

<!-- ══ NET WORTH ══ -->
<div id="networth" class="pg">
  <div class="ph"><div class="ph-left"><div class="ph-eyebrow">Balance Sheet</div><div class="ph-title">Net Worth</div></div></div>
  <div class="pc">
    <div class="grid g4" style="margin-bottom:24px">
      <div class="stat"><div class="stat-label">Net Worth</div><div class="stat-val gld">$142,580</div><div class="stat-sub">Assets minus liabilities</div></div>
      <div class="stat"><div class="stat-label">MoM Change</div><div class="stat-val pos">+$2,140</div><div class="stat-sub">vs Jan 2026</div></div>
      <div class="stat"><div class="stat-label">Total Assets</div><div class="stat-val pos">$394,780</div></div>
      <div class="stat"><div class="stat-label">Total Liabilities</div><div class="stat-val neg">$252,200</div></div>
    </div>
    <div style="display:grid;grid-template-columns:1.2fr 1fr;gap:1px;background:var(--ln);border:1px solid var(--ln);margin-bottom:24px">
      <div style="background:var(--s1);padding:20px">
        <div style="font-family:var(--fm);font-size:9.5px;letter-spacing:.16em;text-transform:uppercase;color:var(--mid);margin-bottom:16px">Net Worth — 7 Month Trend</div>
        <div style="display:flex;align-items:flex-end;gap:3px;height:100px">
          <div style="flex:1;display:flex;flex-direction:column;align-items:center"><div style="font-family:var(--fm);font-size:8px;color:var(--dim);margin-bottom:3px">118k</div><div style="height:75px;width:100%;background:var(--blu);opacity:.3"></div><div style="font-family:var(--fm);font-size:8.5px;color:var(--dim);margin-top:4px">AUG</div></div>
          <div style="flex:1;display:flex;flex-direction:column;align-items:center"><div style="font-family:var(--fm);font-size:8px;color:var(--dim);margin-bottom:3px">122k</div><div style="height:80px;width:100%;background:var(--blu);opacity:.4"></div><div style="font-family:var(--fm);font-size:8.5px;color:var(--dim);margin-top:4px">SEP</div></div>
          <div style="flex:1;display:flex;flex-direction:column;align-items:center"><div style="font-family:var(--fm);font-size:8px;color:var(--dim);margin-bottom:3px">128k</div><div style="height:86px;width:100%;background:var(--blu);opacity:.5"></div><div style="font-family:var(--fm);font-size:8.5px;color:var(--dim);margin-top:4px">OCT</div></div>
          <div style="flex:1;display:flex;flex-direction:column;align-items:center"><div style="font-family:var(--fm);font-size:8px;color:var(--dim);margin-bottom:3px">133k</div><div style="height:90px;width:100%;background:var(--blu);opacity:.6"></div><div style="font-family:var(--fm);font-size:8.5px;color:var(--dim);margin-top:4px">NOV</div></div>
          <div style="flex:1;display:flex;flex-direction:column;align-items:center"><div style="font-family:var(--fm);font-size:8px;color:var(--dim);margin-bottom:3px">138k</div><div style="height:94px;width:100%;background:var(--acc);opacity:.5"></div><div style="font-family:var(--fm);font-size:8.5px;color:var(--dim);margin-top:4px">DEC</div></div>
          <div style="flex:1;display:flex;flex-direction:column;align-items:center"><div style="font-family:var(--fm);font-size:8px;color:var(--dim);margin-bottom:3px">140k</div><div style="height:97px;width:100%;background:var(--acc);opacity:.7"></div><div style="font-family:var(--fm);font-size:8.5px;color:var(--dim);margin-top:4px">JAN</div></div>
          <div style="flex:1;display:flex;flex-direction:column;align-items:center"><div style="font-family:var(--fm);font-size:8px;color:var(--dim);margin-bottom:3px">143k</div><div style="height:100px;width:100%;background:var(--acc)"></div><div style="font-family:var(--fm);font-size:8.5px;color:var(--dim);margin-top:4px">FEB</div></div>
        </div>
      </div>
      <div style="background:var(--s1);padding:20px">
        <div style="font-family:var(--fm);font-size:9.5px;letter-spacing:.16em;text-transform:uppercase;color:var(--mid);margin-bottom:14px">Component Breakdown</div>
        <div class="wfr"><span style="color:var(--txt2)">Cash (Bank)</span><span style="color:var(--pos);font-family:var(--fm)">$9,508</span></div>
        <div class="wfr"><span style="color:var(--txt2)">Investment Portfolio</span><span style="color:var(--blu);font-family:var(--fm)">$31,280</span></div>
        <div class="wfr"><span style="color:var(--txt2)">Real Estate Equity</span><span style="color:var(--gld);font-family:var(--fm)">$354,000</span></div>
        <div class="wfr"><span style="color:var(--txt2)">Home Mortgage</span><span style="color:var(--neg);font-family:var(--fm)">-$248,200</span></div>
        <div class="wfr" style="border:none"><span style="color:var(--txt2)">Car Loan</span><span style="color:var(--neg);font-family:var(--fm)">-$4,000</span></div>
        <div class="wft"><span>Net Worth</span><span style="color:var(--acc);font-family:var(--fm)">$142,580</span></div>
      </div>
    </div>
  </div>
</div>

<!-- ══ IMPORT ══ -->
<div id="upload" class="pg">
  <div class="ph">
    <div class="ph-left"><div class="ph-eyebrow">Data Ingestion</div><div class="ph-title">Import Statement</div></div>
  </div>
  <div class="pc">

    <!-- Drop zone -->
    <div class="dz" style="margin-bottom:24px" onclick="simulateUpload()">
      <div class="dz-icon">UPLOAD</div>
      <div class="dz-title">Drop statement file or click to select</div>
      <div class="dz-sub" style="margin-top:4px">CSV / XLSX — Chase, AmEx, BofA, Citi, Capital One</div>
    </div>

    <!-- Upload Log -->
    <div class="panel">
      <div class="panel-hd" style="display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:10px">
        <div>
          <div class="panel-title">Upload History</div>
          <div style="font-size:11px;color:var(--dim);margin-top:2px" id="ul-log-summary">— files tracked</div>
        </div>
        <div style="font-size:11px;color:var(--mid)">Flag incorrect files · Delete removes only the log record</div>
      </div>
      <table class="tbl" id="upload-log-table">
        <thead>
          <tr>
            <th>Filename</th>
            <th>Uploaded by</th>
            <th>Date &amp; Time</th>
            <th>Rows</th>
            <th>Status</th>
            <th style="text-align:right">Action</th>
          </tr>
        </thead>
        <tbody id="upload-log-body"></tbody>
      </table>
    </div>

  </div>
</div>

<!-- ══ CASH ══ -->
<div id="cash" class="pg">
  <div class="ph">
    <div class="ph-left"><div class="ph-eyebrow">Manual Entry</div><div class="ph-title">Cash Ledger</div></div>
    <div class="ph-actions"><button class="btn btn-acc" onclick="openModal('m-cash')">+ New Entry</button></div>
  </div>
  <div class="pc"><div class="rlist" id="cash-list"></div></div>
</div>

<!-- ══ TRANSACTIONS ══ -->
<div id="txns" class="pg">
  <div class="ph"><div class="ph-left"><div class="ph-eyebrow">Ledger</div><div class="ph-title">Transactions</div></div></div>
  <div class="pc">
    <div class="panel" style="margin-bottom:20px">
      <div class="panel-body" style="padding:14px 20px;display:flex;gap:16px;align-items:flex-end;flex-wrap:wrap">
        <div><label class="flbl" style="margin-top:0">Period</label><select class="finp" style="width:160px"><option>February 2026</option><option>January 2026</option></select></div>
        <div><label class="flbl" style="margin-top:0">Category</label><select class="finp" style="width:160px"><option>All Categories</option></select></div>
        <div style="margin-left:auto;display:flex;gap:20px;align-items:flex-end;padding-bottom:2px">
          <div style="text-align:right"><div style="font-family:var(--fm);font-size:9px;letter-spacing:.16em;text-transform:uppercase;color:var(--dim);margin-bottom:4px">Inflows</div><div style="font-family:var(--fm);font-size:16px;color:var(--pos)">$7,500</div></div>
          <div style="text-align:right"><div style="font-family:var(--fm);font-size:9px;letter-spacing:.16em;text-transform:uppercase;color:var(--dim);margin-bottom:4px">Outflows</div><div style="font-family:var(--fm);font-size:16px;color:var(--neg)">$4,182</div></div>
        </div>
      </div>
    </div>
        <!-- Billing Cycle Banner — shown when CC transactions exist -->
    <div id="cc-cycle-banner" style="margin-bottom:16px;background:var(--accL);border:1px solid var(--acc);border-left:3px solid var(--acc);border-radius:0 var(--radius) var(--radius) 0;padding:12px 18px;display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:10px">
      <div>
        <div style="font-size:10px;letter-spacing:.1em;text-transform:uppercase;color:var(--acc);font-weight:600;margin-bottom:3px" id="cc-banner-cycle-name">Current Cycle</div>
        <div style="font-size:12px;color:var(--txt2)" id="cc-banner-cycle-dates"></div>
      </div>
      <div style="display:flex;gap:24px;align-items:center">
        <div style="text-align:center">
          <div style="font-size:10px;color:var(--mid);text-transform:uppercase;letter-spacing:.08em">Charged so far</div>
          <div style="font-size:18px;font-weight:700;color:var(--neg)" id="cc-banner-charged">$0</div>
        </div>
        <div style="text-align:center">
          <div style="font-size:10px;color:var(--mid);text-transform:uppercase;letter-spacing:.08em">Payment due</div>
          <div style="font-size:18px;font-weight:700;color:var(--acc)" id="cc-banner-due-date">—</div>
        </div>
        <div style="text-align:center">
          <div style="font-size:10px;color:var(--mid);text-transform:uppercase;letter-spacing:.08em">Days to close</div>
          <div style="font-size:18px;font-weight:700;color:var(--gld)" id="cc-banner-days">—</div>
        </div>
      </div>
    </div>
<div class="rlist" id="txn-list"></div>
  </div>
</div>

<!-- ══ FORECAST ══ -->
<div id="forecast" class="pg">
  <div class="ph">
    <div class="ph-left"><div class="ph-eyebrow">Projections</div><div class="ph-title">Cash Flow Forecast</div></div>
    <div class="ph-actions"><button class="btn btn-ghost" onclick="openModal('m-future-exp')">+ Future Expense</button></div>
  </div>
  <div class="pc">
    <div id="fc-scenario-bar" style="display:none;margin-bottom:16px;padding:10px 16px;background:var(--s2);border:1px solid var(--ln);border-left:2px solid var(--acc);font-family:var(--fm);font-size:10px;letter-spacing:.1em;color:var(--acc)"></div>
    <div class="grid g4" style="margin-bottom:24px" id="fc-stats"></div>
    <div id="fc-future-bar" style="display:none;margin-bottom:16px"></div>
    <div class="panel">
      <div class="panel-hd">
        <div class="panel-title" id="fc-table-title">Monthly Projection Table</div>
        <div style="font-family:var(--fm);font-size:9.5px;color:var(--dim);letter-spacing:.08em">Click any month to expand breakdown</div>
      </div>
      <table class="tbl">
        <thead><tr><th style="width:20px"></th><th>Month</th><th>Status</th><th>Income</th><th>Expenses</th><th class="tr">Net</th><th class="tr">Cumulative</th></tr></thead>
        <tbody id="fc-tbody"></tbody>
      </table>
    </div>
  </div>
</div>

<!-- ══ SCENARIOS ══ -->
<div id="scenarios" class="pg">
  <div class="ph">
    <div class="ph-left"><div class="ph-eyebrow">Quantitative Analysis</div><div class="ph-title">Scenario Modeling</div></div>
    <div class="ph-actions" id="sc-apply-bar" style="display:none">
      <button class="btn btn-acc" onclick="applyToForecast()">Apply Active to Forecast</button>
    </div>
  </div>
  <div class="pc">
    <div class="tabs">
      <button class="tab on" onclick="scTab('chat',this)">AI Interface</button>
      <button class="tab" onclick="scTab('saved',this)">Saved Models <span id="sc-count" style="font-family:var(--fm);font-size:9px;background:var(--s4);padding:1px 6px;margin-left:4px;letter-spacing:.06em">3</span></button>
      <button class="tab" onclick="scTab('compare',this)">Comparative Analysis</button>
    </div>

    <!-- CHAT TAB -->
    <div id="sc-chat" style="display:flex;flex-direction:column">
      <div class="chatbox" id="chatbox">
        <div class="msg"><div class="ava acc">AI</div><div class="bub a">Arca Modeling Engine initialized.<br><br>Describe any financial change — a new liability, income adjustment, category reallocation, or early payoff — and I will model the precise impact against your actual data and save a scenario for comparison.</div></div>
        <div class="msg u"><div class="ava">JG</div><div class="bub u">What if I cut dining out by 50% and redirect to mortgage principal?</div></div>
        <div class="msg"><div class="ava acc">AI</div><div class="bub a">Modeling against your actuals:<br><br>Dining avg: <strong>$680/mo</strong>. 50% reduction frees <strong>$340/mo</strong>.<br><br>Applied as extra mortgage principal:<br>— Payoff: Nov 2046 → Oct 2042 <span style="color:var(--acc)">(4 years earlier)</span><br>— Interest saved: <strong>$38,400</strong><br>— FY2026 impact: <strong>+$4,080</strong><div class="scnote">MODEL SAVED — Cut Dining / Mortgage Extra — +$4,080/yr</div></div></div>
      </div>
      <div class="chatrow">
        <textarea class="chatinp" id="chatinp" rows="1" placeholder='e.g. "Model a $35k car loan at 7%" or "Show a $800/mo income increase"'></textarea>
        <button class="chatsend" onclick="sendMsg()">&#x2191;</button>
      </div>
      <div style="font-family:var(--fm);font-size:9.5px;color:var(--dim);margin-top:8px;letter-spacing:.06em">ENTER to send — Models computed against live portfolio data</div>
    </div>

    <!-- SAVED MODELS TAB -->
    <div id="sc-saved" style="display:none">
      <div style="font-family:var(--fm);font-size:9.5px;color:var(--mid);letter-spacing:.1em;margin-bottom:14px">TOGGLE SCENARIOS TO ACTIVATE — ACTIVATE TWO OR MORE TO ENABLE COMBINED FORECAST</div>
      <div id="sc-cards" style="display:flex;flex-direction:column;gap:1px;background:var(--ln);border:1px solid var(--ln)"></div>
      <div id="sc-combined-panel" style="display:none;margin-top:20px">
        <div style="padding:14px 18px;background:var(--s2);border:1px solid var(--ln);border-left:2px solid var(--acc);margin-bottom:1px">
          <div style="font-family:var(--fm);font-size:9px;letter-spacing:.18em;text-transform:uppercase;color:var(--acc);margin-bottom:6px">Combined Active Scenario Impact</div>
          <div style="display:flex;gap:32px;flex-wrap:wrap" id="sc-combined-vals"></div>
        </div>
        <div style="padding:12px 18px;background:var(--s1);border:1px solid var(--ln);border-top:none;font-family:var(--fm);font-size:10px;color:var(--mid)">
          Active: <span id="sc-active-names" style="color:var(--txt)"></span>
        </div>
      </div>
    </div>

    <!-- COMPARE TAB -->
    <div id="sc-compare" style="display:none">
      <div class="grid g3" style="margin-bottom:20px" id="sc-compare-stats"></div>
      <div class="panel">
        <div class="panel-hd"><div class="panel-title">Scenario Impact Matrix</div></div>
        <table class="tbl">
          <thead><tr><th>Scenario</th><th>Status</th><th class="tr">Monthly</th><th class="tr">Annual</th><th class="tr">5-Year</th></tr></thead>
          <tbody id="sc-compare-rows"></tbody>
        </table>
      </div>
    </div>
  </div>
</div>

<!-- ══ LOANS ══ -->
<div id="loans" class="pg">
  <div class="ph">
    <div class="ph-left"><div class="ph-eyebrow">Debt Management</div><div class="ph-title">Liabilities</div></div>
    <div class="ph-actions"><button class="btn btn-acc" onclick="openModal('m-loan')">+ Add Liability</button></div>
  </div>
  <div class="pc">
    <div class="grid g3" style="margin-bottom:24px">
      <div class="stat"><div class="stat-label">Total Outstanding</div><div class="stat-val neg" id="loan-total-debt">$252,200</div><div class="stat-sub" id="loan-count-sub">2 active liabilities</div></div>
      <div class="stat"><div class="stat-label">Monthly Obligation</div><div class="stat-val" id="loan-total-mo">$2,063</div></div>
      <div class="stat"><div class="stat-label">Interest Remaining</div><div class="stat-val" style="color:var(--mid)">$186,440</div></div>
    </div>
    <div id="loans-list"></div>
  </div>
</div>

<!-- ══ PORTFOLIO ══ -->
<div id="investments" class="pg">
  <div class="ph">
    <div class="ph-left"><div class="ph-eyebrow">Asset Management</div><div class="ph-title">Portfolio</div></div>
    <div class="ph-actions"><button class="btn btn-acc" onclick="openModal('m-invest')">+ Log Trade</button></div>
  </div>
  <div class="pc">
    <div style="font-family:var(--fm);font-size:10px;letter-spacing:.12em;color:var(--acc);background:var(--s2);border:1px solid var(--ln);border-left:2px solid var(--acc);padding:10px 16px;margin-bottom:20px">
      Schwab — Connected — Read-only — Last sync 4 min ago
    </div>
    <div class="tabs">
      <button class="tab on" onclick="invTab('ov',this)">Overview</button>
      <button class="tab" onclick="invTab('schw',this)">Schwab Live</button>
      <button class="tab" onclick="invTab('log',this)">Trade Log</button>
    </div>
    <div id="inv-ov">
      <div class="grid g4" style="margin-bottom:20px">
        <div class="stat"><div class="stat-label">Cost Basis</div><div class="stat-val">$24,500</div></div>
        <div class="stat"><div class="stat-label">Market Value</div><div class="stat-val blu">$31,280</div></div>
        <div class="stat"><div class="stat-label">Unrealized P&amp;L</div><div class="stat-val pos">+$6,780</div><div class="stat-sub">+27.7%</div></div>
        <div class="stat"><div class="stat-label">Realized</div><div class="stat-val pos">$3,200</div></div>
      </div>
      <div class="panel">
        <div class="panel-hd"><div class="panel-title">Holdings — Live Quotes</div></div>
        <table class="tbl">
          <thead><tr><th>Name</th><th>Ticker</th><th>Type</th><th class="tr">Live Price</th><th class="tr">Day</th></tr></thead>
          <tbody>
            <tr><td style="font-weight:600">Apple Inc.</td><td style="font-family:var(--fm);color:var(--mid)">AAPL</td><td><span class="tag tag-b">Stock</span></td><td class="tr" style="font-family:var(--fm)">$218.24</td><td class="tr pos">+1.2%</td></tr>
            <tr><td style="font-weight:600">Bitcoin</td><td style="font-family:var(--fm);color:var(--mid)">BTC</td><td><span class="tag tag-y">Crypto</span></td><td class="tr" style="font-family:var(--fm)">$96,420</td><td class="tr pos">+0.8%</td></tr>
            <tr><td style="font-weight:600">Vanguard Total Market</td><td style="font-family:var(--fm);color:var(--mid)">VTSAX</td><td><span class="tag tag-g">ETF</span></td><td class="tr" style="font-family:var(--fm)">$138.44</td><td class="tr neg">-0.3%</td></tr>
            <tr><td style="font-weight:600">S&amp;P 500 ETF</td><td style="font-family:var(--fm);color:var(--mid)">VOO</td><td><span class="tag tag-g">ETF</span></td><td class="tr" style="font-family:var(--fm)">$543.21</td><td class="tr neg">-0.2%</td></tr>
          </tbody>
        </table>
      </div>
    </div>
    <div id="inv-schw" style="display:none">
      <div class="grid g3" style="margin-bottom:20px">
        <div class="stat"><div class="stat-label">Account Value</div><div class="stat-val blu">$31,280</div><div class="stat-sub">...4821</div></div>
        <div class="stat"><div class="stat-label">Cash Balance</div><div class="stat-val pos">$1,840</div></div>
        <div class="stat"><div class="stat-label">Unrealized P&amp;L</div><div class="stat-val pos">+$6,780</div></div>
      </div>
      <div class="panel">
        <div class="panel-hd"><div class="panel-title">Live Positions</div><button class="btn-ghost btn">Refresh</button></div>
        <table class="tbl">
          <thead><tr><th>Symbol</th><th>Qty</th><th>Avg Cost</th><th class="tr">Market Value</th><th class="tr">Unrealized P&amp;L</th></tr></thead>
          <tbody>
            <tr><td style="font-family:var(--fm);font-weight:500">AAPL</td><td style="font-family:var(--fm)">50</td><td style="font-family:var(--fm);color:var(--mid)">$154.20</td><td class="tr" style="font-family:var(--fm)">$10,912</td><td class="tr pos">+$2,202 / +25.3%</td></tr>
            <tr><td style="font-family:var(--fm);font-weight:500">BTC</td><td style="font-family:var(--fm)">0.05</td><td style="font-family:var(--fm);color:var(--mid)">$72,400</td><td class="tr" style="font-family:var(--fm)">$4,821</td><td class="tr pos">+$421 / +9.6%</td></tr>
            <tr><td style="font-family:var(--fm);font-weight:500">VTSAX</td><td style="font-family:var(--fm)">100</td><td style="font-family:var(--fm);color:var(--mid)">$124.18</td><td class="tr" style="font-family:var(--fm)">$13,844</td><td class="tr pos">+$1,626 / +13.3%</td></tr>
            <tr><td style="font-family:var(--fm);font-weight:500">VOO</td><td style="font-family:var(--fm)">8</td><td style="font-family:var(--fm);color:var(--mid)">$467.40</td><td class="tr" style="font-family:var(--fm)">$4,346</td><td class="tr pos">+$608 / +16.3%</td></tr>
          </tbody>
        </table>
      </div>
    </div>
    <div id="inv-log" style="display:none">
      <div class="rlist" id="inv-log-list"></div>
    </div>
  </div>
</div>

<!-- ══ RECON ══ -->
<div id="recon" class="pg">
  <div class="ph"><div class="ph-left"><div class="ph-eyebrow">Verification</div><div class="ph-title">Reconciliation</div></div></div>
  <div class="pc">
    <div class="grid g3" style="margin-bottom:24px">
      <div class="stat"><div class="stat-label">Periods Tracked</div><div class="stat-val">3</div></div>
      <div class="stat"><div class="stat-label">Reconciled</div><div class="stat-val pos">2</div></div>
      <div class="stat"><div class="stat-label">Discrepancies</div><div class="stat-val neg">1</div></div>
    </div>
    <div style="border:1px solid var(--ln);border-left:2px solid var(--pos);background:var(--s1);padding:20px 24px;margin-bottom:1px">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px">
        <div><div style="font-weight:600;font-size:14px">January 2026</div><div style="font-family:var(--fm);font-size:10px;color:var(--mid);margin-top:2px">87 transactions</div></div>
        <span class="tag tag-g">Reconciled</span>
      </div>
      <div class="wfr"><span style="color:var(--txt2)">Opening Balance</span><span style="font-family:var(--fm)">$12,400</span></div>
      <div class="wfr"><span style="color:var(--mid)">+ Inflows</span><span style="font-family:var(--fm);color:var(--pos)">+$7,500</span></div>
      <div class="wfr"><span style="color:var(--mid)">- Outflows</span><span style="font-family:var(--fm);color:var(--neg)">-$5,420</span></div>
      <div class="wfr" style="border:none"><span style="color:var(--mid)">- Investments</span><span style="font-family:var(--fm);color:var(--neg)">-$3,800</span></div>
      <div class="wft"><span>Expected Closing</span><span style="font-family:var(--fm);color:var(--acc)">$10,680</span></div>
      <div style="display:flex;justify-content:space-between;align-items:center;margin-top:16px;padding:14px 16px;background:var(--s2)">
        <div><div style="font-family:var(--fm);font-size:10px;color:var(--mid);letter-spacing:.1em;text-transform:uppercase">Actual Bank Balance</div><div style="font-family:var(--fm);font-size:18px;margin-top:4px">$10,680</div></div>
        <div style="text-align:right"><div style="font-family:var(--fm);font-size:10px;color:var(--dim);letter-spacing:.1em;text-transform:uppercase">Variance</div><div style="font-family:var(--fm);font-size:26px;color:var(--pos);margin-top:4px">$0.00</div></div>
      </div>
    </div>
    <div style="border:1px solid var(--ln);border-left:2px solid var(--neg);background:var(--s1);padding:20px 24px">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px">
        <div><div style="font-weight:600;font-size:14px">February 2026</div><div style="font-family:var(--fm);font-size:10px;color:var(--mid);margin-top:2px">54 transactions</div></div>
        <span class="tag tag-r">-$240 Gap</span>
      </div>
      <div class="wfr"><span style="color:var(--txt2)">Opening Balance</span><span style="font-family:var(--fm)">$10,680</span></div>
      <div class="wfr"><span style="color:var(--mid)">+ Inflows</span><span style="font-family:var(--fm);color:var(--pos)">+$3,750</span></div>
      <div class="wfr"><span style="color:var(--mid)">- Outflows</span><span style="font-family:var(--fm);color:var(--neg)">-$4,182</span></div>
      <div class="wfr" style="border:none"><span style="color:var(--mid)">- Investments</span><span style="font-family:var(--fm);color:var(--neg)">-$500</span></div>
      <div class="wft"><span>Expected Closing</span><span style="font-family:var(--fm);color:var(--acc)">$9,748</span></div>
      <div style="display:flex;justify-content:space-between;align-items:center;margin-top:16px;padding:14px 16px;background:var(--s2)">
        <div><div style="font-family:var(--fm);font-size:10px;color:var(--mid);letter-spacing:.1em;text-transform:uppercase">Actual Bank Balance</div><div style="font-family:var(--fm);font-size:18px;margin-top:4px">$9,508</div></div>
        <div style="text-align:right"><div style="font-family:var(--fm);font-size:10px;color:var(--dim);letter-spacing:.1em;text-transform:uppercase">Variance</div><div style="font-family:var(--fm);font-size:26px;color:var(--neg);margin-top:4px">-$240</div></div>
      </div>
    </div>
  </div>
</div>

<!-- ══ REPORT ══ -->
<div id="reports" class="pg">
  <div class="ph">
    <div class="ph-left"><div class="ph-eyebrow">Year-End Summary</div><div class="ph-title">Annual Report — 2025</div></div>
    <div class="ph-actions">
      <select class="finp" style="width:90px;padding:8px 10px"><option>2025</option><option>2024</option></select>
      <button class="btn btn-acc" onclick="downloadCSV()">Export CSV</button>
    </div>
  </div>
  <div class="pc">
    <div class="grid g3" style="margin-bottom:24px">
      <div class="stat"><div class="stat-label">Total Income</div><div class="stat-val pos">$90,000</div></div>
      <div class="stat"><div class="stat-label">Total Expenses</div><div class="stat-val neg">$71,760</div></div>
      <div class="stat"><div class="stat-label">Net Saved</div><div class="stat-val acc">$18,240</div><div class="stat-sub">20.3% savings rate</div></div>
    </div>
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:1px;background:var(--ln);border:1px solid var(--ln)">
      <div style="background:var(--s1)">
        <div class="panel-hd"><div class="panel-title">Expenditure by Category</div></div>
        <table class="tbl">
          <thead><tr><th>Category</th><th class="tr">Total</th><th class="tr">Share</th></tr></thead>
          <tbody>
            <tr><td>Housing</td><td class="tr" style="font-family:var(--fm)">$22,200</td><td class="tr" style="font-family:var(--fm);color:var(--mid)">30.9%</td></tr>
            <tr><td>Childcare</td><td class="tr" style="font-family:var(--fm)">$14,400</td><td class="tr" style="font-family:var(--fm);color:var(--mid)">20.1%</td></tr>
            <tr><td>Dining Out</td><td class="tr" style="font-family:var(--fm)">$8,160</td><td class="tr" style="font-family:var(--fm);color:var(--mid)">11.4%</td></tr>
            <tr><td>Groceries</td><td class="tr" style="font-family:var(--fm)">$6,240</td><td class="tr" style="font-family:var(--fm);color:var(--mid)">8.7%</td></tr>
            <tr><td>Investments</td><td class="tr" style="font-family:var(--fm)">$6,000</td><td class="tr" style="font-family:var(--fm);color:var(--mid)">8.4%</td></tr>
            <tr><td>Transport</td><td class="tr" style="font-family:var(--fm)">$4,080</td><td class="tr" style="font-family:var(--fm);color:var(--mid)">5.7%</td></tr>
          </tbody>
        </table>
      </div>
      <div style="background:var(--s1)">
        <div class="panel-hd"><div class="panel-title">Monthly Summary</div></div>
        <table class="tbl">
          <thead><tr><th>Month</th><th class="tr">Income</th><th class="tr">Expenses</th><th class="tr">Net</th></tr></thead>
          <tbody>
            <tr><td>January</td><td class="tr" style="font-family:var(--fm)">$7,500</td><td class="tr" style="font-family:var(--fm)">$5,820</td><td class="tr gld">+$1,680</td></tr>
            <tr><td>February</td><td class="tr" style="font-family:var(--fm)">$7,500</td><td class="tr" style="font-family:var(--fm)">$4,182</td><td class="tr gld">+$3,318</td></tr>
            <tr><td>March</td><td class="tr" style="font-family:var(--fm)">$7,500</td><td class="tr" style="font-family:var(--fm)">$6,120</td><td class="tr gld">+$1,380</td></tr>
            <tr><td>April</td><td class="tr" style="font-family:var(--fm)">$7,500</td><td class="tr" style="font-family:var(--fm)">$5,980</td><td class="tr gld">+$1,520</td></tr>
            <tr><td>May</td><td class="tr" style="font-family:var(--fm)">$7,500</td><td class="tr" style="font-family:var(--fm)">$6,200</td><td class="tr gld">+$1,300</td></tr>
            <tr><td>June</td><td class="tr" style="font-family:var(--fm)">$7,500</td><td class="tr" style="font-family:var(--fm)">$5,800</td><td class="tr gld">+$1,700</td></tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>
</div>

<!-- ══ CATEGORIES ══ -->
<div id="cats" class="pg">
  <div class="ph">
    <div class="ph-left"><div class="ph-eyebrow">Configuration</div><div class="ph-title">Categories</div></div>
    <div class="ph-actions"><button class="btn btn-acc" onclick="openModal('m-cat')">+ Add Category</button></div>
  </div>
  <div class="pc"><div id="cats-list"></div></div>
</div>
<!-- ══ PROFILE ══ -->
<div id="profile" class="pg">
  <div class="ph">
    <div class="ph-left"><div class="ph-eyebrow">Account Configuration</div><div class="ph-title">User Profile</div></div>
    <div class="ph-actions"><button class="btn btn-acc" onclick="saveProfile()">Save Changes</button></div>
  </div>
  <div class="pc">

    <!-- FX STATUS BAR -->
    <div id="profile-fx-bar" style="margin-bottom:20px;padding:11px 16px;background:var(--s2);border:1px solid var(--ln);border-left:2px solid var(--acc);font-family:var(--fm);font-size:10px;letter-spacing:.1em;color:var(--mid)">
      LOADING EXCHANGE RATE...
    </div>

    <div class="prof-two-col" style="display:grid;grid-template-columns:1.2fr 1fr;gap:1px;background:var(--ln);border:1px solid var(--ln);margin-bottom:20px">
      <!-- LEFT: Identity -->
      <div style="background:var(--s1);padding:24px">
        <div style="font-family:var(--fm);font-size:9.5px;letter-spacing:.16em;text-transform:uppercase;color:var(--mid);margin-bottom:16px">Identity</div>
        <div class="fg2">
          <div class="fgrp"><label class="flbl">First Name</label><input class="finp" id="p-fname" value="Jorge"></div>
          <div class="fgrp"><label class="flbl">Last Name</label><input class="finp" id="p-lname" value="Garcia"></div>
        </div>
        <div class="fgrp"><label class="flbl">Email</label><input class="finp" id="p-email" value="garcia@example.com" type="email"></div>
        <div class="fgrp"><label class="flbl">Access Level</label>
          <select class="finp" id="p-access">
            <option value="PRV">PRV — Private</option>
            <option value="FAM">FAM — Family</option>
            <option value="BUS">BUS — Business</option>
          </select>
        </div>
      </div>
      <!-- RIGHT: Locale & Currency -->
      <div style="background:var(--s1);padding:24px">
        <div style="font-family:var(--fm);font-size:9.5px;letter-spacing:.16em;text-transform:uppercase;color:var(--mid);margin-bottom:16px">Locale &amp; Currency</div>
        <div class="fgrp">
          <label class="flbl">Registered Country</label>
          <select class="finp" id="p-country" onchange="onCountryChange()">
            <option value="GT">Guatemala — GTQ</option>
            <option value="MX">Mexico — MXN</option>
            <option value="CO">Colombia — COP</option>
            <option value="AR">Argentina — ARS</option>
            <option value="CL">Chile — CLP</option>
            <option value="PE">Peru — PEN</option>
            <option value="ES">Spain — EUR</option>
            <option value="DE">Germany — EUR</option>
            <option value="US">United States — USD</option>
            <option value="GB">United Kingdom — GBP</option>
            <option value="CA">Canada — CAD</option>
            <option value="JP">Japan — JPY</option>
            <option value="BR">Brazil — BRL</option>
          </select>
        </div>
        <div class="fgrp">
          <label class="flbl">Home Currency (auto-set by country)</label>
          <div id="p-cur-display" style="padding:10px 14px;background:var(--s3);border:1px solid var(--ln);font-family:var(--fm);font-size:12.5px;color:var(--acc)">GTQ — Guatemalan Quetzal</div>
        </div>
        <div class="fgrp">
          <label class="flbl">Default Entry Currency</label>
          <select class="finp" id="p-def-cur">
            <option value="home">Home currency (auto)</option>
            <option value="USD">Always USD</option>
          </select>
        </div>
        <div id="p-rate-box" style="margin-top:12px;padding:12px 14px;background:var(--s2);border:1px solid var(--ln);font-family:var(--fm);font-size:11px">
          <div style="font-family:var(--fm);font-size:9px;letter-spacing:.16em;text-transform:uppercase;color:var(--dim);margin-bottom:6px">Official Exchange Rate</div>
          <div id="p-rate-val" style="font-size:18px;color:var(--acc)">Loading...</div>
          <div id="p-rate-src" style="color:var(--dim);margin-top:4px;font-size:10px"></div>
          <button class="btn btn-ghost" style="margin-top:10px;font-size:10px" onclick="fetchExchangeRate()">Refresh Rate</button>
        </div>
      </div>
    </div>

    <!-- Rate history / conversion table -->
    <div class="panel">
      <div class="panel-hd"><div class="panel-title" id="p-conv-title">Quick Conversion — GTQ to USD</div></div>
      <div style="padding:16px 20px">
        <div style="display:flex;gap:12px;align-items:flex-end;margin-bottom:16px;flex-wrap:wrap">
          <div><label class="flbl">Amount</label><input class="finp" type="number" id="p-conv-amt" placeholder="1000" oninput="updateConvTable()" style="width:140px"></div>
          <div style="font-family:var(--fm);font-size:10px;color:var(--dim);padding-bottom:12px">Enter any amount to convert</div>
        </div>
        <div id="p-conv-table" class="conv-table-4" style="display:grid;grid-template-columns:repeat(4,1fr);gap:1px;background:var(--ln);border:1px solid var(--ln)"></div>
      </div>
    </div>


    <!-- ── BILLING CYCLE SETTINGS ─────────────────────────────── -->
    <div style="margin-top:20px;background:var(--s1);border:1px solid var(--ln);border-radius:var(--radius);overflow:hidden">
      <div style="padding:14px 20px;border-bottom:1px solid var(--ln);display:flex;align-items:center;justify-content:space-between">
        <div style="font-size:10.5px;letter-spacing:.1em;text-transform:uppercase;color:var(--mid);font-weight:500">Credit Card Billing Cycle</div>
        <span class="tag tag-b">Cash flow planning</span>
      </div>
      <div style="padding:20px">
        <div style="font-size:12px;color:var(--mid);margin-bottom:18px;line-height:1.6;padding:10px 14px;background:var(--accL);border-left:2px solid var(--acc);border-radius:0 3px 3px 0">
          Charges made between the <strong id="cc-cycle-explain-prev"></strong> and <strong id="cc-cycle-explain-close"></strong> of each month form one billing cycle, paid on the <strong id="cc-cycle-explain-pay"></strong>. Arca uses these dates to group spending and place the payment on the correct day in your cash flow forecast.
        </div>
        <div class="fg2" style="margin-bottom:16px">
          <div>
            <label class="flbl">Cycle closes on (day of month)</label>
            <input class="finp" type="number" id="cc-close-day" min="1" max="31" value="21" oninput="updateCycleExplain()">
            <div style="font-size:11px;color:var(--dim);margin-top:5px">Statement is locked on this date each month</div>
          </div>
          <div>
            <label class="flbl">Payment due on (day of month)</label>
            <input class="finp" type="number" id="cc-pay-day" min="1" max="31" value="26" oninput="updateCycleExplain()">
            <div style="font-size:11px;color:var(--dim);margin-top:5px">When you pay — aligns with income arrival</div>
          </div>
        </div>
        <div class="fg2" style="margin-bottom:0">
          <div>
            <label class="flbl">Card nickname</label>
            <input class="finp" type="text" id="cc-nickname" value="Visa Rewards" placeholder="e.g. Visa Rewards">
          </div>
          <div>
            <label class="flbl">Income source covering payment</label>
            <select class="finp" id="cc-income-source">
              <option value="salary">Salary (26th)</option>
              <option value="freelance">Freelance Income</option>
              <option value="manual">Manual / Variable</option>
            </select>
          </div>
        </div>

        <!-- Live cycle preview -->
        <div id="cc-cycle-preview" style="margin-top:20px;background:var(--s2);border:1px solid var(--ln);border-radius:var(--radius);padding:20px">
          <div style="font-size:10px;letter-spacing:.1em;text-transform:uppercase;color:var(--dim);font-weight:500;margin-bottom:14px">Current Cycle Preview</div>

          <!-- Visual timeline -->
          <div id="cc-timeline-wrap" style="margin-bottom:18px"></div>

          <!-- 3-card stat grid -->
          <div class="cc-card-grid" id="cc-cycle-cards"></div>

          <!-- Explanation text -->
          <div style="margin-top:14px;font-size:11.5px;color:var(--txt2);line-height:1.7;padding:12px 14px;background:var(--s1);border:1px solid var(--ln);border-radius:var(--radius)" id="cc-cycle-note"></div>

          <!-- How Arca uses this -->
          <div style="margin-top:12px;padding:12px 14px;border-left:3px solid var(--acc);background:var(--accL);border-radius:0 var(--radius) var(--radius) 0">
            <div style="font-size:10px;letter-spacing:.1em;text-transform:uppercase;color:var(--acc);font-weight:600;margin-bottom:6px">How Arca uses this</div>
            <div id="cc-arca-note" style="font-size:11.5px;color:var(--txt2);line-height:1.7"></div>
          </div>
        </div>
      </div>
    </div>
    <div id="profile-saved-banner" style="display:none;margin-top:16px;padding:11px 16px;background:var(--s2);border-left:2px solid var(--acc);font-family:var(--fm);font-size:10.5px;color:var(--acc);letter-spacing:.08em">
      PROFILE SAVED — EXCHANGE RATE APPLIED GLOBALLY
    </div>
  </div>
</div>

<!-- ══ HOUSEHOLD ══ -->
<div id="household" class="pg">
  <div class="ph">
    <div class="ph-left">
      <div class="ph-eyebrow">Shared Finance</div>
      <div class="ph-title">Household</div>
    </div>
    <div class="ph-actions">
      <button class="btn btn-out" onclick="openModal('m-invite')">+ Invite member</button>
    </div>
  </div>
  <div class="pc">

    <!-- Member pills -->
    <div style="display:flex;align-items:center;gap:10px;margin-bottom:24px;flex-wrap:wrap">
      <div id="hh-member-pills" style="display:flex;gap:8px"></div>
      <span style="margin-left:auto;font-size:11px;color:var(--dim);display:none" class="hh-desktop-note">Both members see the same data</span>
    </div>

    <!-- Stats -->
    <div class="grid g4" style="margin-bottom:24px" id="hh-stats"></div>

    <!-- Contribution bar -->
    <div style="background:var(--s1);border:1px solid var(--ln);border-radius:var(--radius);padding:18px 22px;margin-bottom:20px">
      <div style="font-size:10px;letter-spacing:.1em;text-transform:uppercase;color:var(--dim);font-weight:500;margin-bottom:12px">Expenses by member</div>
      <div style="height:6px;border-radius:3px;overflow:hidden;display:flex;margin-bottom:10px" id="hh-contrib-fill"></div>
      <div style="display:flex;gap:20px;font-size:12px;color:var(--txt2)" id="hh-contrib-legend"></div>
    </div>

    <!-- All transactions merged -->
    <div class="panel">
      <div class="panel-hd">
        <div class="panel-title">All Transactions</div>
        <div style="display:flex;gap:6px" id="hh-filters"></div>
      </div>
      <div id="hh-txn-list"></div>
    </div>

  </div>
</div>


</main>
</div>

<!-- ═════════ MODALS ═════════ -->

<!-- ADD CASH -->
<div class="mo" id="m-cash" onclick="bgClose(event,'m-cash')">
  <div class="mbox">
    <div class="mhd"><div class="mtitle">New Cash Entry</div><button class="mclose" onclick="closeModal('m-cash')">x</button></div>
    <div class="mbody">
      <div class="fg2">
        <div><label class="flbl">Date</label><input class="finp" type="date" id="c-date"></div>
        <div><label class="flbl">Amount (USD)</label><input class="finp" type="number" id="c-amt" placeholder="0.00" min="0" step="0.01"></div>
      </div>
      <div class="fgrp"><label class="flbl">Description</label><input class="finp" type="text" id="c-desc" placeholder="Payee or description"></div>
      <div class="fg2">
        <div><label class="flbl">Category</label>
          <select class="finp" id="c-cat">
            <option>Groceries</option><option>Dining Out</option><option>Childcare</option><option>Transport</option>
            <option>Entertainment</option><option>Housing</option><option>Gifts</option><option>Other Income</option><option>Healthcare</option><option>Other</option>
          </select>
        </div>
        <div><label class="flbl">Method</label>
          <select class="finp" id="c-type"><option>Cash</option><option>Venmo</option><option>Zelle</option><option>Check</option><option>Other</option></select>
        </div>
      </div>
      <div class="fg2">
        <div><label class="flbl">Direction</label>
          <select class="finp" id="c-dir"><option value="-">Expense — Outflow</option><option value="+">Income — Inflow</option></select>
        </div>
        <div><label class="flbl">Currency</label>
          <select class="finp" id="c-cur" onchange="updateCashPreview()">
            <option value="USD">USD ($)</option>
            <option value="home">Home currency (profile)</option>
          </select>
        </div>
      </div>
      <div id="c-fx-preview" style="display:none;padding:9px 12px;background:var(--s2);border-left:2px solid var(--blu);font-family:var(--fm);font-size:10.5px;color:var(--mid);margin-bottom:8px"></div>
      <div class="flash" id="c-flash">Entry recorded successfully</div>
    </div>
    <div class="mactions">
      <button class="btn btn-out" onclick="closeModal('m-cash')">Cancel</button>
      <button class="btn btn-acc" onclick="saveCash()">Record Entry</button>
    </div>
  </div>
</div>

<!-- ADD LOAN -->
<div class="mo" id="m-loan" onclick="bgClose(event,'m-loan')">
  <div class="mbox">
    <div class="mhd"><div class="mtitle">Add Liability</div><button class="mclose" onclick="closeModal('m-loan')">x</button></div>
    <div class="mbody">
      <div class="fgrp"><label class="flbl">Liability Name</label><input class="finp" type="text" id="l-name" placeholder="e.g. Student Loan, Auto Loan"></div>
      <div class="fgrp"><label class="flbl">Type</label>
        <select class="finp" id="l-type">
          <option value="M">Mortgage</option><option value="A">Auto Loan</option><option value="S">Student Loan</option><option value="P">Personal Loan</option><option value="B">Business Loan</option><option value="O">Other</option>
        </select>
      </div>
      <div class="fg2">
        <div><label class="flbl">Original Principal (USD)</label><input class="finp" type="number" id="l-orig" placeholder="25,000" oninput="loanPreview()"></div>
        <div><label class="flbl">Current Balance (USD)</label><input class="finp" type="number" id="l-bal" placeholder="22,000" oninput="loanPreview()"></div>
      </div>
      <div class="fg2">
        <div><label class="flbl">Interest Rate (% APR)</label><input class="finp" type="number" id="l-rate" placeholder="6.5" step="0.01" oninput="loanPreview()"></div>
        <div><label class="flbl">Term (months)</label><input class="finp" type="number" id="l-term" placeholder="60" oninput="loanPreview()"></div>
      </div>
      <div class="preview-box" id="l-preview"></div>
      <div class="flash" id="l-flash">Liability recorded</div>
    </div>
    <div class="mactions">
      <button class="btn btn-out" onclick="closeModal('m-loan')">Cancel</button>
      <button class="btn btn-acc" onclick="saveLoan()">Add Liability</button>
    </div>
  </div>
</div>

<!-- LOG TRADE -->
<div class="mo" id="m-invest" onclick="bgClose(event,'m-invest')">
  <div class="mbox">
    <div class="mhd"><div class="mtitle">Log Trade</div><button class="mclose" onclick="closeModal('m-invest')">x</button></div>
    <div class="mbody">
      <div class="fg2">
        <div><label class="flbl">Action</label>
          <select class="finp" id="i-action"><option>Buy</option><option>Sell</option><option>Dividend</option></select>
        </div>
        <div><label class="flbl">Date</label><input class="finp" type="date" id="i-date"></div>
      </div>
      <div class="fg2">
        <div><label class="flbl">Ticker / Symbol</label><input class="finp" type="text" id="i-ticker" placeholder="AAPL, BTC, VTSAX" style="text-transform:uppercase"></div>
        <div><label class="flbl">Asset Class</label>
          <select class="finp" id="i-type"><option>Equity</option><option>ETF</option><option>Crypto</option><option>Fixed Income</option><option>Other</option></select>
        </div>
      </div>
      <div class="fg2">
        <div><label class="flbl">Quantity</label><input class="finp" type="number" id="i-qty" placeholder="10" step="any" oninput="invCalc()"></div>
        <div><label class="flbl">Price per Unit (USD)</label><input class="finp" type="number" id="i-price" placeholder="218.24" step="0.01" oninput="invCalc()"></div>
      </div>
      <div class="fgrp"><label class="flbl">Total Amount (USD)</label><input class="finp" type="number" id="i-total" placeholder="Auto-calculated" step="0.01" oninput="invCalcRev()"></div>
      <div class="fg2">
        <div><label class="flbl">Notes</label><input class="finp" type="text" id="i-notes" placeholder="e.g. DCA, rebalance"></div>
        <div><label class="flbl">Currency</label>
          <select class="finp" id="i-cur" onchange="updateInvPreview()">
            <option value="USD">USD ($)</option>
            <option value="home">Home currency (profile)</option>
          </select>
        </div>
      </div>
      <div id="i-fx-preview" style="display:none;padding:9px 12px;background:var(--s2);border-left:2px solid var(--blu);font-family:var(--fm);font-size:10.5px;color:var(--mid);margin-bottom:8px"></div>
      <div class="flash" id="i-flash">Trade recorded successfully</div>
    </div>
    <div class="mactions">
      <button class="btn btn-out" onclick="closeModal('m-invest')">Cancel</button>
      <button class="btn btn-acc" onclick="saveInvest()">Record Trade</button>
    </div>
  </div>
</div>

<!-- ADD CATEGORY -->
<div class="mo" id="m-cat" onclick="bgClose(event,'m-cat')">
  <div class="mbox">
    <div class="mhd"><div class="mtitle">Add Category</div><button class="mclose" onclick="closeModal('m-cat')">x</button></div>
    <div class="mbody">
      <div class="fg2">
        <div><label class="flbl">Name</label><input class="finp" type="text" id="k-name" placeholder="e.g. Travel, Medical"></div>
        <div><label class="flbl">Monthly Budget (USD)</label><input class="finp" type="number" id="k-budget" placeholder="200"></div>
      </div>
      <div class="fgrp"><label class="flbl">Accent Color</label>
        <div class="clr-opts">
          <div class="clr-swatch on" data-c="#60a5fa" style="background:#60a5fa" onclick="pickClr(this)"></div>
          <div class="clr-swatch" data-c="#4ade80" style="background:#4ade80" onclick="pickClr(this)"></div>
          <div class="clr-swatch" data-c="#f87171" style="background:#f87171" onclick="pickClr(this)"></div>
          <div class="clr-swatch" data-c="#fbbf24" style="background:#fbbf24" onclick="pickClr(this)"></div>
          <div class="clr-swatch" data-c="#c8f542" style="background:#c8f542" onclick="pickClr(this)"></div>
          <div class="clr-swatch" data-c="#a78bfa" style="background:#a78bfa" onclick="pickClr(this)"></div>
          <div class="clr-swatch" data-c="#fb923c" style="background:#fb923c" onclick="pickClr(this)"></div>
          <div class="clr-swatch" data-c="#94a3b8" style="background:#94a3b8" onclick="pickClr(this)"></div>
        </div>
      </div>
      <div class="flash" id="k-flash">Category added</div>
    </div>
    <div class="mactions">
      <button class="btn btn-out" onclick="closeModal('m-cat')">Cancel</button>
      <button class="btn btn-acc" onclick="saveCat()">Add Category</button>
    </div>
  </div>
</div>

<!-- AUTH SUCCESS -->
<div class="mo" id="m-signin" onclick="bgClose(event,'m-signin')">
  <div class="mbox">
    <div class="mhd"><div class="mtitle">Authentication Successful</div><button class="mclose" onclick="closeModal('m-signin')">x</button></div>
    <div class="mbody">
      <div style="font-family:var(--fm);font-size:10px;letter-spacing:.14em;color:var(--acc);background:var(--s2);border-left:2px solid var(--acc);padding:12px 16px;margin-bottom:16px">SESSION ESTABLISHED — GARCIA, JORGE — PRV ACCESS — TLS 1.3</div>
      <div style="font-family:var(--fm);font-size:12px;color:var(--mid);line-height:1.8">
        Last login: Feb 22, 2026 — 21:44 EST<br>
        Access level: Private<br>
        Session expires: 24 hours
      </div>
    </div>
    <div class="mactions">
      <button class="btn btn-acc" style="flex:1;justify-content:center" onclick="closeModal('m-signin');go('dashboard',null,'Dashboard')">Enter Dashboard</button>
    </div>
  </div>
</div>

<script>
// ── AUTH GATE ─────────────────────────────────────────────────────────────
function previewSignIn() {
  var gate = document.getElementById('auth-gate');
  if (!gate) return;
  gate.style.opacity = '0';
  gate.style.pointerEvents = 'none';
  setTimeout(function() { gate.style.display = 'none'; }, 320);
}

function authTab(tab) {
  var inBtn = document.getElementById('auth-tab-in');
  var upBtn = document.getElementById('auth-tab-up');
  if (inBtn) {
    inBtn.style.background = tab === 'in' ? 'var(--acc)' : 'transparent';
    inBtn.style.color      = tab === 'in' ? '#fff' : 'var(--mid)';
  }
  if (upBtn) {
    upBtn.style.background = tab === 'up' ? 'var(--acc)' : 'transparent';
    upBtn.style.color      = tab === 'up' ? '#fff' : 'var(--mid)';
  }
}


// ══════════════════════════════════════════════════════════════
//  ARCA — CURRENCY + SCENARIO + FORECAST ENGINE
// ══════════════════════════════════════════════════════════════

// ── USER PROFILE ──────────────────────────────────────────────
var userProfile = {
  firstName: 'Jorge',
  lastName: 'Garcia',
  email: 'garcia@example.com',
  access: 'PRV',
  country: 'GT',
  homeCurrency: 'GTQ',
  defCurMode: 'home'
};

// Country → currency map
var COUNTRY_CUR = {
  GT:'GTQ', MX:'MXN', CO:'COP', AR:'ARS', CL:'CLP', PE:'PEN',
  ES:'EUR', DE:'EUR', US:'USD', GB:'GBP', CA:'CAD', JP:'JPY', BR:'BRL'
};
var CUR_NAMES = {
  GTQ:'Guatemalan Quetzal', MXN:'Mexican Peso', COP:'Colombian Peso',
  ARS:'Argentine Peso', CLP:'Chilean Peso', PEN:'Peruvian Sol',
  EUR:'Euro', USD:'US Dollar', GBP:'British Pound', CAD:'Canadian Dollar',
  JPY:'Japanese Yen', BRL:'Brazilian Real'
};
var CUR_SYMBOLS = {
  GTQ:'Q', MXN:'$', COP:'$', ARS:'$', CLP:'$', PEN:'S/',
  EUR:'€', USD:'$', GBP:'£', CAD:'$', JPY:'¥', BRL:'R$'
};

// ── EXCHANGE RATES (live-fetched via Anthropic API, fallback hardcoded) ──
// Official source: Banco de Guatemala, Banxico, etc. per country
var FX_RATES = {
  GTQ: { rate: 0.13028, label:'1 GTQ = $0.13028 USD', source:'Banco de Guatemala (Banguat)', date:'Feb 23, 2026', fetched:false },
  MXN: { rate: 0.04880, label:'1 MXN = $0.0488 USD',  source:'Banco de México (Banxico)', date:'Feb 23, 2026', fetched:false },
  COP: { rate: 0.000235, label:'1 COP = $0.000235 USD', source:'Banco de la República Colombia', date:'Feb 23, 2026', fetched:false },
  ARS: { rate: 0.000970, label:'1 ARS = $0.00097 USD', source:'Banco Central Argentina (BCRA)', date:'Feb 23, 2026', fetched:false },
  CLP: { rate: 0.001048, label:'1 CLP = $0.001048 USD', source:'Banco Central de Chile', date:'Feb 23, 2026', fetched:false },
  PEN: { rate: 0.26667, label:'1 PEN = $0.2667 USD', source:'Banco Central de Reserva del Perú', date:'Feb 23, 2026', fetched:false },
  EUR: { rate: 1.08330, label:'1 EUR = $1.0833 USD', source:'European Central Bank (ECB)', date:'Feb 23, 2026', fetched:false },
  GBP: { rate: 1.26410, label:'1 GBP = $1.2641 USD', source:'Bank of England', date:'Feb 23, 2026', fetched:false },
  CAD: { rate: 0.71200, label:'1 CAD = $0.712 USD', source:'Bank of Canada', date:'Feb 23, 2026', fetched:false },
  JPY: { rate: 0.00657, label:'1 JPY = $0.00657 USD', source:'Bank of Japan', date:'Feb 23, 2026', fetched:false },
  BRL: { rate: 0.17280, label:'1 BRL = $0.1728 USD', source:'Banco Central do Brasil', date:'Feb 23, 2026', fetched:false },
  USD: { rate: 1.00000, label:'1 USD = $1.0000 USD', source:'Base currency', date:'—', fetched:true }
};
var fxFetching = false;

function toUSD(amt, cur) {
  var c = (cur === 'home') ? userProfile.homeCurrency : cur;
  return amt * (FX_RATES[c] ? FX_RATES[c].rate : 1);
}
function homeSym() { return CUR_SYMBOLS[userProfile.homeCurrency] || ''; }
function homeCurLabel() { return userProfile.homeCurrency + ' ' + homeSym(); }

// ── LIVE RATE FETCH (Anthropic API) ──────────────────────────────────────
async function fetchExchangeRate(showSpinner) {
  var cur = userProfile.homeCurrency;
  if (cur === 'USD') { updateFXDisplay(); return; }
  if (fxFetching) return;
  fxFetching = true;
  var rateBox = document.getElementById('p-rate-val');
  var srcBox  = document.getElementById('p-rate-src');
  var fxBar   = document.getElementById('profile-fx-bar');
  if (rateBox) rateBox.innerHTML = '<span style="color:var(--dim)">Fetching from central bank...</span>';
  if (fxBar) fxBar.innerHTML = 'FETCHING OFFICIAL RATE — '+cur+'/USD — CENTRAL BANK SOURCE...';

  var fxInfo = FX_RATES[cur] || {};
  var prompt = 'What is the current official exchange rate of '+cur+' to USD as of today? ' +
    'Respond ONLY with a JSON object in this exact format, no other text: ' +
    '{"rate":0.13028,"label":"1 '+cur+' = $X.XXXXX USD","source":"Central bank name","date":"Month DD, YYYY"}';

  try {
    var resp = await fetch('https://api.anthropic.com/v1/messages', {
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body: JSON.stringify({
        model:'claude-sonnet-4-20250514',
        max_tokens:200,
        system:'You are a financial data assistant. Respond ONLY with valid JSON. No markdown, no backticks, no explanation.',
        messages:[{role:'user',content:prompt}]
      })
    });
    var data = await resp.json();
    var raw = data.content && data.content[0] && data.content[0].text ? data.content[0].text.trim() : '';
    raw = raw.replace(/```json|```/g,'').trim();
    var parsed = JSON.parse(raw);
    if (parsed.rate && parsed.rate > 0) {
      FX_RATES[cur] = { rate: parsed.rate, label: parsed.label, source: parsed.source, date: parsed.date, fetched: true };
      console.log('FX fetched:', cur, parsed);
    }
  } catch(e) {
    console.warn('FX fetch failed, using fallback:', e.message);
    FX_RATES[cur].fetched = false;
  }
  fxFetching = false;
  updateFXDisplay();
  renderConvTable();
}

function updateFXDisplay() {
  var cur = userProfile.homeCurrency;
  var fx = FX_RATES[cur] || {};
  var rateBox = document.getElementById('p-rate-val');
  var srcBox  = document.getElementById('p-rate-src');
  var fxBar   = document.getElementById('profile-fx-bar');
  var titleEl = document.getElementById('p-conv-title');
  if (rateBox) {
    rateBox.innerHTML = fx.label || (cur+' rate unavailable');
    rateBox.style.color = fx.fetched ? 'var(--acc)' : 'var(--gld)';
  }
  if (srcBox) {
    srcBox.innerHTML = (fx.source||'') + (fx.date?' — '+fx.date:'') + (fx.fetched?' <span style="color:var(--acc)">LIVE</span>':' <span style="color:var(--gld)">CACHED</span>');
  }
  if (fxBar) {
    var indicator = fx.fetched ? '<span style="color:var(--acc)">LIVE</span>' : '<span style="color:var(--gld)">CACHED</span>';
    fxBar.innerHTML = 'OFFICIAL RATE — 1 '+cur+' = $'+fx.rate.toFixed(5)+' USD &nbsp;|&nbsp; '+fx.source+' &nbsp;|&nbsp; '+indicator;
  }
  if (titleEl) titleEl.textContent = 'Quick Conversion — '+cur+' to USD';
  updateConvTable();
  refreshCurrencyDropdowns();
}

function refreshCurrencyDropdowns() {
  var cur = userProfile.homeCurrency;
  var sym = CUR_SYMBOLS[cur] || '';
  var rate = (FX_RATES[cur]||{}).rate || 1;
  var label = cur+' ('+sym+') — 1 '+cur+' = $'+rate.toFixed(5)+' USD';
  // Update all 'home' option labels
  document.querySelectorAll('option[value="home"]').forEach(function(o){
    o.textContent = 'Home: '+label;
  });
}

function updateConvTable() {
  var cur = userProfile.homeCurrency;
  if (cur === 'USD') return;
  var amt = parseFloat(document.getElementById('p-conv-amt') && document.getElementById('p-conv-amt').value) || 1;
  renderConvTable(amt);
}
function renderConvTable(baseAmt) {
  var cur = userProfile.homeCurrency;
  if (cur === 'USD') {
    var el = document.getElementById('p-conv-table');
    if (el) el.innerHTML = '<div style="background:var(--s1);padding:16px;font-family:var(--fm);font-size:11px;color:var(--mid);grid-column:1/-1">Home currency is USD — no conversion needed.</div>';
    return;
  }
  var el = document.getElementById('p-conv-table');
  if (!el) return;
  var fx = FX_RATES[cur] || {};
  var amounts = baseAmt ? [baseAmt, baseAmt*5, baseAmt*10, baseAmt*100] : [1, 100, 500, 1000];
  el.innerHTML = amounts.map(function(a) {
    var usd = toUSD(a, cur);
    return '<div style="background:var(--s1);padding:14px 16px">'+
      '<div style="font-family:var(--fm);font-size:9px;color:var(--dim);letter-spacing:.12em;text-transform:uppercase;margin-bottom:5px">'+cur+'</div>'+
      '<div style="font-family:var(--fm);font-size:16px;color:var(--txt)">'+(CUR_SYMBOLS[cur]||'')+' '+a.toLocaleString(undefined,{minimumFractionDigits:2,maximumFractionDigits:2})+'</div>'+
      '<div style="font-family:var(--fm);font-size:11px;color:var(--acc);margin-top:4px">= $'+usd.toLocaleString(undefined,{minimumFractionDigits:2,maximumFractionDigits:2})+' USD</div>'+
      '<div style="font-family:var(--fm);font-size:9px;color:var(--dim);margin-top:2px">@ '+fx.rate.toFixed(5)+'</div></div>';
  }).join('');
}

// ── PROFILE FUNCTIONS ─────────────────────────────────────────────────────
function onCountryChange() {
  var country = document.getElementById('p-country').value;
  var cur = COUNTRY_CUR[country] || 'USD';
  userProfile.country = country;
  userProfile.homeCurrency = cur;
  var disp = document.getElementById('p-cur-display');
  if (disp) disp.textContent = cur + ' — ' + (CUR_NAMES[cur]||cur);
  // Trigger live rate fetch
  fetchExchangeRate(true);
}

function saveProfile() {
  userProfile.firstName = (document.getElementById('p-fname')||{}).value || userProfile.firstName;
  userProfile.lastName  = (document.getElementById('p-lname')||{}).value || userProfile.lastName;
  userProfile.email     = (document.getElementById('p-email')||{}).value || userProfile.email;
  userProfile.access    = (document.getElementById('p-access')||{}).value || userProfile.access;
  userProfile.defCurMode= (document.getElementById('p-def-cur')||{}).value || userProfile.defCurMode;
  // Update sidebar label
  var lbl = document.getElementById('sb-user-label');
  if (lbl) lbl.textContent = userProfile.lastName.toUpperCase()+', '+userProfile.firstName.toUpperCase()+' / '+userProfile.access;
  // Show banner
  var b = document.getElementById('profile-saved-banner');
  if (b) { b.style.display='block'; setTimeout(function(){b.style.display='none';}, 2500); }
}

// ── CURRENCY PREVIEW HELPERS ──────────────────────────────────────────────
function fmtConvert(amt, cur) {
  var c = (cur==='home') ? userProfile.homeCurrency : cur;
  var usd = toUSD(amt, c);
  var sym = CUR_SYMBOLS[c] || '';
  var src = (FX_RATES[c]||{}).source || 'Official rate';
  if (c === 'USD') return null;
  return sym+' '+amt.toFixed(2)+' '+c+' → $'+usd.toFixed(2)+' USD &nbsp;|&nbsp; Rate: '+(FX_RATES[c]||{}).rate+' &nbsp;|&nbsp; '+src;
}
function updateCashPreview() {
  var cur = document.getElementById('c-cur').value;
  var amt = parseFloat(document.getElementById('c-amt').value)||0;
  var box = document.getElementById('c-fx-preview');
  var msg = amt ? fmtConvert(amt, cur) : null;
  if (!msg) { box.style.display='none'; return; }
  box.style.display='block'; box.innerHTML = msg;
}
function updateInvPreview() {
  var cur = document.getElementById('i-cur').value;
  var amt = parseFloat(document.getElementById('i-total').value)||0;
  var box = document.getElementById('i-fx-preview');
  var msg = amt ? fmtConvert(amt, cur) : null;
  if (!msg) { box.style.display='none'; return; }
  box.style.display='block'; box.innerHTML = msg;
}
function updateFEPreview() {
  var cur  = document.getElementById('fe-cur').value;
  var amt  = parseFloat(document.getElementById('fe-amt').value)||0;
  var box  = document.getElementById('fe-preview');
  var abox = document.getElementById('fe-analysis');
  if (!amt) { box.style.display='none'; abox.style.display='none'; return; }
  var c    = (cur==='home') ? userProfile.homeCurrency : cur;
  var usd  = toUSD(amt, c);
  var msg  = fmtConvert(amt, cur);
  box.style.display = 'block';
  box.innerHTML = msg ? msg : '$'+usd.toFixed(2)+' USD (no conversion)';

  // ── Scenario analysis ────────────────────────────────────────
  var baseNet = 1520;
  var activeScenarios = scenarioModels.filter(function(m){ return m.active; });
  var scenarioDelta   = activeScenarios.reduce(function(a,m){ return a+m.monthlyDelta; }, 0);
  var adjNet = baseNet + scenarioDelta;
  var moBase = Math.ceil(usd / Math.max(1, baseNet));
  var moAdj  = adjNet > 0 ? Math.ceil(usd / adjNet) : null;
  var month  = parseInt(document.getElementById('fe-month').value);
  var mnths  = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];

  abox.style.display = 'block';
  var html = '<div style="color:var(--txt2);margin-bottom:6px">COST ANALYSIS — $'+usd.toFixed(0)+' USD &nbsp;|&nbsp; TARGET: '+mnths[month-1]+' 2026</div>';
  html += '<div style="margin-bottom:4px">Without scenarios: <strong>'+moBase+' months</strong> of net income ($'+baseNet+'/mo)</div>';
  if (activeScenarios.length > 0) {
    var deltaSign = scenarioDelta >= 0 ? '+' : '';
    html += '<div style="color:var(--acc)">Active scenarios: <strong>'+activeScenarios.map(function(m){return m.name;}).join(' + ')+'</strong> ('+deltaSign+scenarioDelta+'/mo)</div>';
    if (moAdj !== null) {
      var diff = moBase - moAdj;
      var diffStr = diff > 0 ? '<span style="color:var(--pos)">'+diff+' fewer months</span>' : diff < 0 ? '<span style="color:var(--neg)">'+Math.abs(diff)+' more months</span>' : 'no change';
      html += '<div style="margin-top:4px">With scenarios: <strong style="color:var(--acc)">'+moAdj+' months</strong> ('+diffStr+')</div>';
    }
    // Can you fund by target month?
    var moUntilTarget = month - 2; // Feb = current month 2
    if (moAdj !== null && moUntilTarget > 0) {
      var canFund = moAdj <= moUntilTarget;
      html += '<div style="margin-top:6px;padding:7px 10px;background:var(--s3);'+(canFund?'border-left:2px solid var(--pos)':'border-left:2px solid var(--neg)')+'">'+
        (canFund?'CAN FUND by target month with active scenarios':'INSUFFICIENT — need '+(moAdj-moUntilTarget)+' more months')+'</div>';
    }
  }
  abox.innerHTML = html;
}

// ── DATA ─────────────────────────────────────────────────────────────────
var cashData=[
  {date:'FEB 22',desc:'Farmer\'s Market',cat:'Groceries',type:'Cash',dir:'-',amt:45},
  {date:'FEB 20',desc:'Babysitter — Saturday',cat:'Childcare',type:'Cash',dir:'-',amt:80},
  {date:'FEB 18',desc:'Venmo — Split Dinner',cat:'Dining Out',type:'Venmo',dir:'-',amt:34.50},
  {date:'FEB 15',desc:'Birthday Gift — Nephew',cat:'Gifts',type:'Cash',dir:'-',amt:50},
  {date:'FEB 12',desc:'Garage Sale Proceeds',cat:'Other Income',type:'Cash',dir:'+',amt:120}
];
var txnData=[
  {date:'FEB 22',desc:'Whole Foods Market',cat:'Groceries',dir:'-',amt:94.30},
  {date:'FEB 21',desc:'Salary Deposit',cat:'Income',dir:'+',amt:3750},
  {date:'FEB 20',desc:'Little Stars Daycare',cat:'Childcare',dir:'-',amt:600},
  {date:'FEB 18',desc:'Netflix Subscription',cat:'Entertainment',dir:'-',amt:15.99},
  {date:'FEB 17',desc:'Robinhood — AAPL Purchase',cat:'Investments',dir:'-',amt:500},
  {date:'FEB 15',desc:'Mortgage Payment',cat:'Housing',dir:'-',amt:1850},
  {date:'FEB 14',desc:'Shell — Fuel',cat:'Transport',dir:'-',amt:62.40}
];
var loanData=[
  {name:'Home Mortgage',type:'M',bal:248200,monthly:1850,rate:6.25,payoff:'Nov 2046',pct:22,color:'#60a5fa'},
  {name:'Honda CR-V Auto',type:'A',bal:4000,monthly:213,rate:5.9,payoff:'Mar 2027',pct:82,color:'#4ade80'}
];
var invData=[
  {date:'FEB 17',name:'Apple Inc.',ticker:'AAPL',type:'Equity',action:'Buy',qty:10,amt:1750},
  {date:'FEB 10',name:'Bitcoin',ticker:'BTC',type:'Crypto',action:'Buy',qty:0.05,amt:2300},
  {date:'JAN 28',name:'Vanguard Total Market',ticker:'VTSAX',type:'ETF',action:'Buy',qty:20,amt:3800},
  {date:'JAN 15',name:'Tesla Inc.',ticker:'TSLA',type:'Equity',action:'Sell',qty:5,amt:1200}
];
var catData=[
  {name:'Housing',budget:2000,spent:2400,color:'#60a5fa'},
  {name:'Dining Out',budget:500,spent:680,color:'#f87171'},
  {name:'Groceries',budget:600,spent:520,color:'#4ade80'},
  {name:'Childcare',budget:1200,spent:1200,color:'#fbbf24'},
  {name:'Entertainment',budget:200,spent:120,color:'#a78bfa'}
];
var selColor='#60a5fa';
var futureExpenses = [];

// ── SCENARIO DATA ────────────────────────────────────────────────────────
var scenarioModels = [
  {id:1, name:'Cut Dining / Mortgage', desc:'Dining -50%, redirect to principal', monthlyDelta:340, annualDelta:4080, active:false,
   adjustments:[{label:'Cut Dining Out',val:'-$340/mo',sign:-1},{label:'Extra Principal',val:'+$340/mo',sign:1}]},
  {id:2, name:'Baby Year 2', desc:'Childcare and healthcare cost increase', monthlyDelta:-550, annualDelta:-6600, active:false,
   adjustments:[{label:'Childcare',val:'+$400/mo',sign:-1},{label:'Healthcare',val:'+$150/mo',sign:-1}]},
  {id:3, name:'Side Income', desc:'+$1,500/mo consulting income', monthlyDelta:1500, annualDelta:18000, active:false,
   adjustments:[{label:'Consulting Income',val:'+$1,500/mo',sign:1}]}
];

// ── RENDERS ──────────────────────────────────────────────────────────────
function tag(txt,cls){return '<span class="tag tag-'+cls+'">'+txt+'</span>';}

function renderCash(){
  var el=document.getElementById('cash-list');
  if(!el)return;
  el.innerHTML=cashData.map(function(e){
    var s=e.dir==='+'?'+':'−'; var c=e.dir==='+'?'pos':'neg';
    return '<div class="rrow"><div class="rrow-l"><div class="rrow-name">'+e.desc+'</div>'+
      '<div class="rrow-sub" style="display:flex;gap:10px">'+
      '<span>'+e.date+'</span><span style="color:var(--dim)">'+e.cat.toUpperCase()+'</span>'+
      '<span class="tag tag-d">'+e.type.toUpperCase()+'</span></div></div>'+
      '<div class="rrow-r"><div class="rrow-amt" style="color:var(--'+c+')">'+s+'$'+e.amt.toFixed(2)+'</div></div></div>';
  }).join('');
}
function renderTxns(){
  var el=document.getElementById('txn-list');
  if(!el)return;
  el.innerHTML=txnData.map(function(e){
    var s=e.dir==='+'?'+':'−'; var c=e.dir==='+'?'pos':'neg';
    return '<div class="rrow"><div class="rrow-l"><div class="rrow-name">'+e.desc+'</div>'+
      '<div class="rrow-sub"><span>'+e.date+'</span> &nbsp; <span style="color:var(--dim)">'+e.cat.toUpperCase()+'</span></div></div>'+
      '<div class="rrow-r"><div class="rrow-amt" style="color:var(--'+c+')">'+s+'$'+e.amt.toFixed(2)+'</div></div></div>';
  }).join('');
}
function renderLoans(){
  var el=document.getElementById('loans-list');
  if(!el)return;
  el.innerHTML=loanData.map(function(l){
    var types={M:'Mortgage',A:'Auto Loan',S:'Student Loan',P:'Personal Loan',B:'Business Loan',O:'Other'};
    return '<div class="lcard">'+
      '<div style="display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:16px">'+
        '<div><div style="font-weight:700;font-size:14px;margin-bottom:3px">'+l.name+'</div>'+
        '<div style="font-family:var(--fm);font-size:10px;color:var(--mid);letter-spacing:.1em">'+types[l.type].toUpperCase()+' — '+l.rate+'% APR</div></div>'+
        '<span class="tag tag-d">'+types[l.type].toUpperCase()+'</span></div>'+
      '<div style="display:grid;grid-template-columns:repeat(3,1fr);gap:16px;margin-bottom:16px">'+
        '<div><div style="font-family:var(--fm);font-size:9px;letter-spacing:.16em;text-transform:uppercase;color:var(--dim);margin-bottom:5px">Balance</div><div style="font-family:var(--fm);font-size:16px;color:var(--neg)">$'+l.bal.toLocaleString()+'</div></div>'+
        '<div><div style="font-family:var(--fm);font-size:9px;letter-spacing:.16em;text-transform:uppercase;color:var(--dim);margin-bottom:5px">Monthly</div><div style="font-family:var(--fm);font-size:16px">$'+l.monthly.toLocaleString()+'</div></div>'+
        '<div><div style="font-family:var(--fm);font-size:9px;letter-spacing:.16em;text-transform:uppercase;color:var(--dim);margin-bottom:5px">Payoff</div><div style="font-family:var(--fm);font-size:16px;color:var(--gld)">'+l.payoff+'</div></div></div>'+
      '<div style="font-family:var(--fm);font-size:9.5px;color:var(--dim);display:flex;justify-content:space-between;margin-bottom:5px;letter-spacing:.08em"><span>'+l.pct+'% RETIRED</span><span>'+Math.round(l.bal/l.monthly)+' MO REMAINING</span></div>'+
      '<div class="prog"><div class="progf" style="width:'+l.pct+'%;background:'+l.color+'"></div></div></div>';
  }).join('');
  var td=loanData.reduce(function(a,l){return a+l.bal;},0);
  var tm=loanData.reduce(function(a,l){return a+l.monthly;},0);
  var dEl=document.getElementById('loan-total-debt'); if(dEl)dEl.textContent='$'+td.toLocaleString();
  var mEl=document.getElementById('loan-total-mo');   if(mEl)mEl.textContent='$'+tm.toLocaleString();
  var cEl=document.getElementById('loan-count-sub');  if(cEl)cEl.textContent=loanData.length+' active liabilities';
}
function renderInvLog(){
  var el=document.getElementById('inv-log-list');
  if(!el)return;
  el.innerHTML=invData.map(function(i){
    var s=i.action==='Sell'?'+':'−'; var c=i.action==='Sell'?'pos':'neg';
    var tc=i.action==='Sell'?'g':'r';
    return '<div class="rrow"><div class="rrow-l">'+
      '<div class="rrow-name">'+i.name+' <span style="font-family:var(--fm);font-size:10.5px;color:var(--mid)">'+i.ticker+'</span></div>'+
      '<div class="rrow-sub"><span>'+i.date+'</span> <span style="color:var(--dim)">'+i.qty+' '+(i.type==='Crypto'?'UNITS':'SHS')+'</span> <span class="tag tag-'+tc+'">'+i.action.toUpperCase()+'</span></div></div>'+
      '<div class="rrow-r"><div class="rrow-amt" style="color:var(--'+c+')">'+s+'$'+i.amt.toLocaleString()+'</div></div></div>';
  }).join('');
}
function renderCats(){
  var el=document.getElementById('cats-list');
  if(!el)return;
  el.innerHTML='<div style="display:flex;flex-direction:column;gap:1px;border:1px solid var(--ln);background:var(--ln)">'+
  catData.map(function(c){
    var over=c.spent>c.budget;
    var pct=Math.min(100,Math.round(c.spent/c.budget*100));
    var badge=over?tag('OVER BUDGET','r'):c.spent===c.budget?tag('ON BUDGET','g'):tag('$'+(c.budget-c.spent)+' REMAINING','g');
    return '<div style="background:var(--s1);padding:16px 20px">'+
      '<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px">'+
        '<div style="font-weight:600;letter-spacing:.02em">'+c.name+'</div>'+badge+'</div>'+
      '<div style="display:flex;justify-content:space-between;font-family:var(--fm);font-size:10.5px;margin-bottom:7px">'+
        '<span style="color:var(--dim)">BUDGET $'+c.budget.toLocaleString()+'</span>'+
        '<span style="color:'+(over?'var(--neg)':'var(--txt2)')+'">'+(over?'OVER ':'')+'$'+c.spent.toLocaleString()+' SPENT</span></div>'+
      '<div class="prog"><div class="progf" style="width:'+pct+'%;background:'+(over?'var(--neg)':c.color)+'"></div></div></div>';
  }).join('')+'</div>';
}
function renderDashCats(){
  var mx=Math.max.apply(null,catData.map(function(c){return c.spent;}));
  var el=document.getElementById('dash-cats');
  if(!el)return;
  el.innerHTML=catData.slice(0,5).map(function(c){
    var pct=Math.round(c.spent/mx*100);
    return '<div style="display:flex;align-items:center;gap:14px;padding:12px 20px;border-bottom:1px solid var(--s3)">'+
      '<div style="font-family:var(--fm);font-size:10px;color:var(--mid);width:80px;letter-spacing:.06em;text-transform:uppercase;flex-shrink:0">'+c.name+'</div>'+
      '<div style="flex:1"><div class="prog" style="height:3px"><div class="progf" style="width:'+pct+'%;background:'+c.color+'"></div></div></div>'+
      '<div style="font-family:var(--fm);font-size:12.5px;color:var(--txt2);width:60px;text-align:right;flex-shrink:0">$'+c.spent.toLocaleString()+'</div></div>';
  }).join('');
}

// ── SCENARIO RENDERS ─────────────────────────────────────────────────────
function renderScCards(){
  var el=document.getElementById('sc-cards');
  if(!el)return;
  var activeCount=scenarioModels.filter(function(m){return m.active;}).length;
  el.innerHTML=scenarioModels.map(function(m){
    var border=m.active?'border-left:2px solid var(--acc);':'';
    var statusLabel=m.active?
      '<span style="font-family:var(--fm);font-size:9px;letter-spacing:.16em;text-transform:uppercase;color:var(--acc)">ACTIVE</span>':
      '<span style="font-family:var(--fm);font-size:9px;letter-spacing:.16em;text-transform:uppercase;color:var(--dim)">INACTIVE</span>';
    var btnLabel=m.active?'Deactivate':'Activate';
    var btnClass=m.active?'btn btn-acc':'btn btn-ghost';
    var deltaColor=m.monthlyDelta>=0?'var(--pos)':'var(--neg)';
    var adjs=m.adjustments.map(function(a){
      var c=a.sign>0?'var(--pos)':'var(--neg)';
      return '<div style="font-family:var(--fm);font-size:11px;padding:6px 10px;background:var(--s3);display:flex;justify-content:space-between;margin-bottom:2px">'+
        '<span style="color:var(--mid)">'+a.label+'</span><span style="color:'+c+'">'+a.val+'</span></div>';
    }).join('');
    return '<div style="background:var(--s1);padding:20px;'+border+'">'+
      '<div style="display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:8px">'+statusLabel+
      '<button class="'+btnClass+'" style="font-size:11px;padding:5px 10px" onclick="toggleScenario('+m.id+')">'+btnLabel+'</button></div>'+
      '<div style="font-weight:700;font-size:14px;margin-bottom:4px">'+m.name+'</div>'+
      '<div style="font-family:var(--fm);font-size:11px;color:var(--mid);margin-bottom:14px">'+m.desc+'</div>'+
      adjs+
      '<div style="display:flex;justify-content:space-between;align-items:flex-end;margin-top:12px">'+
        '<div><div style="font-family:var(--fm);font-size:9px;color:var(--dim);letter-spacing:.12em;text-transform:uppercase">Monthly Delta</div>'+
        '<div style="font-family:var(--fm);font-size:18px;color:'+deltaColor+'">'+(m.monthlyDelta>=0?'+':'')+m.monthlyDelta.toFixed(0)+'/mo</div></div>'+
        '<div style="text-align:right"><div style="font-family:var(--fm);font-size:9px;color:var(--dim);letter-spacing:.12em;text-transform:uppercase">Annual Delta</div>'+
        '<div style="font-family:var(--fm);font-size:14px;color:'+deltaColor+'">'+(m.annualDelta>=0?'+':'')+m.annualDelta.toLocaleString()+'</div></div>'+
      '</div></div>';
  }).join('');
  updateCombinedPanel();
  var applyBar=document.getElementById('sc-apply-bar');
  if(applyBar) applyBar.style.display=activeCount>=1?'flex':'none';
}

function toggleScenario(id){
  var m=scenarioModels.find(function(x){return x.id===id;});
  if(m) m.active=!m.active;
  renderScCards();
  renderScCompare();
  // Live-update FE analysis if modal is open
  updateFEPreview();
}

function updateCombinedPanel(){
  var active=scenarioModels.filter(function(m){return m.active;});
  var panel=document.getElementById('sc-combined-panel');
  if(!panel)return;
  if(active.length<2){panel.style.display='none';return;}
  panel.style.display='block';
  var totalMonthly=active.reduce(function(a,m){return a+m.monthlyDelta;},0);
  var totalAnnual=active.reduce(function(a,m){return a+m.annualDelta;},0);
  var base=1520;
  var combined=base+totalMonthly;
  var mc=totalMonthly>=0?'var(--pos)':'var(--neg)';
  var cv=document.getElementById('sc-combined-vals');
  if(cv) cv.innerHTML=
    '<div><div style="font-family:var(--fm);font-size:9px;color:var(--dim);letter-spacing:.12em;text-transform:uppercase;margin-bottom:4px">Combined Monthly Delta</div>'+
    '<div style="font-family:var(--fm);font-size:22px;color:'+mc+'">'+(totalMonthly>=0?'+':'')+totalMonthly.toFixed(0)+'/mo</div></div>'+
    '<div><div style="font-family:var(--fm);font-size:9px;color:var(--dim);letter-spacing:.12em;text-transform:uppercase;margin-bottom:4px">Combined Annual</div>'+
    '<div style="font-family:var(--fm);font-size:22px;color:'+mc+'">'+(totalAnnual>=0?'+':'')+totalAnnual.toLocaleString()+'</div></div>'+
    '<div><div style="font-family:var(--fm);font-size:9px;color:var(--dim);letter-spacing:.12em;text-transform:uppercase;margin-bottom:4px">Adjusted Monthly Net</div>'+
    '<div style="font-family:var(--fm);font-size:22px;color:var(--acc)">$'+combined.toFixed(0)+'/mo</div></div>';
  var an=document.getElementById('sc-active-names');
  if(an) an.textContent=active.map(function(m){return m.name;}).join(' + ');
}

function renderScCompare(){
  var base=1520;
  var statsEl=document.getElementById('sc-compare-stats');
  var rowsEl=document.getElementById('sc-compare-rows');
  if(!statsEl||!rowsEl)return;
  statsEl.innerHTML='<div class="stat"><div class="stat-label">Baseline</div><div class="stat-val acc">$'+base+'/mo</div><div class="stat-sub">Present monthly net</div></div>'+
    scenarioModels.map(function(m){
      var c=m.monthlyDelta>=0?'pos':'neg';
      var border=m.active?'border-left:2px solid var(--acc);':'';
      return '<div class="stat" style="'+border+'"><div class="stat-label">'+m.name+'</div>'+
        '<div class="stat-val '+c+'">$'+(base+m.monthlyDelta).toFixed(0)+'/mo</div>'+
        '<div class="stat-sub" style="color:var('+(m.active?'--acc':'--dim')+')">'+(m.active?'ACTIVE — ':'')+
        (m.monthlyDelta>=0?'+':'')+m.monthlyDelta.toFixed(0)+'/mo vs base</div></div>';
    }).join('');
  rowsEl.innerHTML=scenarioModels.map(function(m){
    var c=m.monthlyDelta>=0?'pos':'neg';
    var activeBadge=m.active?tag('ACTIVE','g'):tag('OFF','d');
    return '<tr><td style="font-weight:600">'+m.name+'</td><td>'+activeBadge+'</td>'+
      '<td class="tr '+c+'">'+(m.monthlyDelta>=0?'+':'')+m.monthlyDelta.toFixed(0)+'</td>'+
      '<td class="tr '+c+'">'+(m.annualDelta>=0?'+':'')+m.annualDelta.toLocaleString()+'</td>'+
      '<td class="tr '+c+'">'+(m.annualDelta*5>=0?'+':'')+(m.annualDelta*5).toLocaleString()+'</td></tr>';
  }).join('');
}

// ── FORECAST ENGINE ──────────────────────────────────────────────────────
// Category colors mapped to the app palette
var CAT_COLORS = {
  'Salary':       '#4ade80',
  'Freelance':    '#c8f542',
  'Other Income': '#60a5fa',
  'Housing':      '#60a5fa',
  'Childcare':    '#fbbf24',
  'Dining Out':   '#f87171',
  'Groceries':    '#4ade80',
  'Transport':    '#a78bfa',
  'Entertainment':'#94a3b8',
  'Healthcare':   '#fb923c',
  'Investments':  '#c8f542',
  'Utilities':    '#6b6b78',
  'Gifts':        '#fb923c',
  'Insurance':    '#94a3b8',
  'Clothing':     '#a78bfa',
  'Other':        '#6b6b78'
};

var BASE_MONTHS=[
  {label:'January 2026',   idx:0,  status:'actual',
   incomeItems:[{name:'Salary',amt:7500}],
   expenseItems:[{name:'Housing',amt:1850},{name:'Childcare',amt:1200},{name:'Groceries',amt:520},{name:'Dining Out',amt:680},{name:'Transport',amt:340},{name:'Entertainment',amt:120},{name:'Utilities',amt:180},{name:'Insurance',amt:220},{name:'Investments',amt:500},{name:'Other',amt:210}]},
  {label:'February 2026',  idx:1,  status:'current',
   incomeItems:[{name:'Salary',amt:7500}],
   expenseItems:[{name:'Housing',amt:1850},{name:'Childcare',amt:1200},{name:'Groceries',amt:450},{name:'Dining Out',amt:200},{name:'Transport',amt:62},{name:'Entertainment',amt:16},{name:'Utilities',amt:180},{name:'Insurance',amt:220},{name:'Investments',amt:0},{name:'Other',amt:4}]},
  {label:'March 2026',     idx:2,  status:'proj',
   incomeItems:[{name:'Salary',amt:7500}],
   expenseItems:[{name:'Housing',amt:1850},{name:'Childcare',amt:1200},{name:'Groceries',amt:520},{name:'Dining Out',amt:680},{name:'Transport',amt:340},{name:'Entertainment',amt:120},{name:'Utilities',amt:180},{name:'Insurance',amt:220},{name:'Investments',amt:500},{name:'Other',amt:350}]},
  {label:'April 2026',     idx:3,  status:'proj',
   incomeItems:[{name:'Salary',amt:7500}],
   expenseItems:[{name:'Housing',amt:1850},{name:'Childcare',amt:1200},{name:'Groceries',amt:520},{name:'Dining Out',amt:680},{name:'Transport',amt:340},{name:'Entertainment',amt:120},{name:'Utilities',amt:180},{name:'Insurance',amt:220},{name:'Investments',amt:500},{name:'Other',amt:350}]},
  {label:'May 2026',       idx:4,  status:'proj',
   incomeItems:[{name:'Salary',amt:7500}],
   expenseItems:[{name:'Housing',amt:1850},{name:'Childcare',amt:1200},{name:'Groceries',amt:520},{name:'Dining Out',amt:680},{name:'Transport',amt:340},{name:'Entertainment',amt:120},{name:'Utilities',amt:180},{name:'Insurance',amt:220},{name:'Investments',amt:500},{name:'Other',amt:350}]},
  {label:'June 2026',      idx:5,  status:'proj',
   incomeItems:[{name:'Salary',amt:7500}],
   expenseItems:[{name:'Housing',amt:1850},{name:'Childcare',amt:1200},{name:'Groceries',amt:520},{name:'Dining Out',amt:680},{name:'Transport',amt:340},{name:'Entertainment',amt:120},{name:'Utilities',amt:180},{name:'Insurance',amt:220},{name:'Investments',amt:500},{name:'Clothing',amt:200},{name:'Other',amt:150}]},
  {label:'July 2026',      idx:6,  status:'proj',
   incomeItems:[{name:'Salary',amt:7500}],
   expenseItems:[{name:'Housing',amt:1850},{name:'Childcare',amt:1200},{name:'Groceries',amt:520},{name:'Dining Out',amt:680},{name:'Transport',amt:340},{name:'Entertainment',amt:120},{name:'Utilities',amt:180},{name:'Insurance',amt:220},{name:'Investments',amt:500},{name:'Other',amt:350}]},
  {label:'August 2026',    idx:7,  status:'proj',
   incomeItems:[{name:'Salary',amt:7500}],
   expenseItems:[{name:'Housing',amt:1850},{name:'Childcare',amt:1200},{name:'Groceries',amt:520},{name:'Dining Out',amt:680},{name:'Transport',amt:340},{name:'Entertainment',amt:120},{name:'Utilities',amt:180},{name:'Insurance',amt:220},{name:'Investments',amt:500},{name:'Other',amt:350}]},
  {label:'September 2026', idx:8,  status:'proj',
   incomeItems:[{name:'Salary',amt:7500}],
   expenseItems:[{name:'Housing',amt:1850},{name:'Childcare',amt:1200},{name:'Groceries',amt:520},{name:'Dining Out',amt:680},{name:'Transport',amt:340},{name:'Entertainment',amt:120},{name:'Utilities',amt:180},{name:'Insurance',amt:220},{name:'Investments',amt:500},{name:'Other',amt:350}]},
  {label:'October 2026',   idx:9,  status:'proj',
   incomeItems:[{name:'Salary',amt:7500}],
   expenseItems:[{name:'Housing',amt:1850},{name:'Childcare',amt:1200},{name:'Groceries',amt:520},{name:'Dining Out',amt:680},{name:'Transport',amt:340},{name:'Entertainment',amt:120},{name:'Utilities',amt:180},{name:'Insurance',amt:220},{name:'Investments',amt:500},{name:'Other',amt:350}]},
  {label:'November 2026',  idx:10, status:'proj',
   incomeItems:[{name:'Salary',amt:7500}],
   expenseItems:[{name:'Housing',amt:1850},{name:'Childcare',amt:1200},{name:'Groceries',amt:520},{name:'Dining Out',amt:680},{name:'Transport',amt:340},{name:'Entertainment',amt:120},{name:'Utilities',amt:180},{name:'Insurance',amt:220},{name:'Investments',amt:500},{name:'Gifts',amt:250},{name:'Other',amt:100}]},
  {label:'December 2026',  idx:11, status:'proj',
   incomeItems:[{name:'Salary',amt:7500}],
   expenseItems:[{name:'Housing',amt:1850},{name:'Childcare',amt:1200},{name:'Groceries',amt:520},{name:'Dining Out',amt:680},{name:'Transport',amt:340},{name:'Entertainment',amt:220},{name:'Utilities',amt:180},{name:'Insurance',amt:220},{name:'Investments',amt:500},{name:'Gifts',amt:500},{name:'Other',amt:200}]}
];

function buildRowDetail(m, row, active, hasFE){
  // Build income lines
  var incItems = m.incomeItems ? m.incomeItems.slice() : [{name:'Salary', amt:row.income}];
  // Apply scenario income deltas
  active.forEach(function(sc){
    if(sc.monthlyDelta > 0 && m.status==='proj'){
      incItems.push({name:sc.name+' (scenario)', amt:sc.monthlyDelta, scenario:true});
    }
  });

  // Build expense lines from base
  var expItems = m.expenseItems ? m.expenseItems.map(function(e){
    return {name:e.name, amt:e.amt, base:true};
  }) : [{name:'Total Expenses', amt:row.expenses}];

  // Apply scenario expense adjustments
  active.forEach(function(sc){
    if(sc.monthlyDelta < 0 && m.status==='proj'){
      // Find "Dining Out" specifically if cut dining scenario
      if(sc.name.indexOf('Dining')!==-1){
        var d = expItems.find(function(e){return e.name==='Dining Out';});
        if(d){ d.amt = Math.max(0, d.amt + sc.monthlyDelta); d.modified=true; }
      } else {
        expItems.push({name:sc.name+' (scenario)', amt: Math.abs(sc.monthlyDelta), scenario:true});
      }
    }
  });

  // Add future expenses
  futureExpenses.filter(function(fe){return fe.month-1===m.idx;}).forEach(function(fe){
    expItems.push({name:fe.desc+(fe.recurring?' [recurring]':''), amt:fe.amtUSD, future:true});
  });

  var maxExp = Math.max.apply(null, expItems.map(function(e){return e.amt;}));
  var totalInc = incItems.reduce(function(a,i){return a+i.amt;},0);
  var totalExp = expItems.reduce(function(a,e){return a+e.amt;},0);

  var incRows = incItems.map(function(i){
    var c = CAT_COLORS[i.name] || '#4ade80';
    var label = i.scenario ? '<span style="color:var(--acc);font-size:9px;margin-left:6px">SCENARIO</span>' : '';
    return '<div class="fc-inc-row">'+
      '<div style="display:flex;align-items:center;flex:1"><div class="fc-cat-dot" style="background:'+c+'"></div>'+
      '<span class="fc-cat-name">'+i.name+'</span>'+label+'</div>'+
      '<span class="fc-cat-amt" style="color:var(--pos)">+$'+i.amt.toLocaleString()+'</span></div>';
  }).join('');

  var expRows = expItems.map(function(e){
    var c = CAT_COLORS[e.name] || 'var(--dim)';
    var pct = maxExp > 0 ? Math.round(e.amt/maxExp*100) : 0;
    var amtColor = e.future ? 'var(--neg)' : e.modified ? 'var(--acc)' : e.scenario ? 'var(--neg)' : 'var(--txt2)';
    var badge = e.future ? '<span style="font-family:var(--fm);font-size:8px;color:var(--neg);margin-left:6px;letter-spacing:.1em">FUTURE</span>'
              : e.modified ? '<span style="font-family:var(--fm);font-size:8px;color:var(--acc);margin-left:6px">MODIFIED</span>'
              : e.scenario ? '<span style="font-family:var(--fm);font-size:8px;color:var(--neg);margin-left:6px">SCENARIO</span>'
              : '';
    return '<div class="fc-cat-row">'+
      '<div class="fc-cat-dot" style="background:'+c+'"></div>'+
      '<span class="fc-cat-name">'+e.name+'</span>'+badge+
      '<div class="fc-cat-bar-wrap"><div class="fc-cat-bar" style="width:'+pct+'%;background:'+c+'"></div></div>'+
      '<span class="fc-cat-amt" style="color:'+amtColor+'">-$'+e.amt.toLocaleString()+'</span></div>';
  }).join('');

  return '<div class="fc-detail-inner">'+
    '<div style="display:grid;grid-template-columns:1fr 1fr;gap:0;border-bottom:1px solid var(--s4)">'+
      '<div style="border-right:1px solid var(--s4)">'+
        '<div class="fc-section-hd">Income — $'+totalInc.toLocaleString()+'</div>'+incRows+'</div>'+
      '<div>'+
        '<div class="fc-section-hd">Expenses — $'+totalExp.toLocaleString()+'</div>'+expRows+'</div>'+
    '</div>'+
    '<div style="display:flex;justify-content:space-between;padding:10px 20px 10px 0;font-family:var(--fm);font-size:11px">'+
      '<span style="color:var(--dim)">NET THIS MONTH</span>'+
      '<span style="color:'+(totalInc-totalExp>=0?'var(--pos)':'var(--neg)')+'">'+
        (totalInc-totalExp>=0?'+':'')+' $'+(totalInc-totalExp).toLocaleString()+'</span></div>'+
  '</div>';
}

var openMonthIdx = null;

function toggleMonthDetail(idx){
  if(openMonthIdx === idx){
    // close
    var det = document.getElementById('fc-det-'+idx);
    if(det){ det.classList.remove('open'); }
    var btn = document.getElementById('fc-btn-'+idx);
    if(btn){ btn.textContent='+'; btn.classList.remove('open'); }
    openMonthIdx = null;
  } else {
    // close prev
    if(openMonthIdx !== null){
      var prev = document.getElementById('fc-det-'+openMonthIdx);
      if(prev) prev.classList.remove('open');
      var pb = document.getElementById('fc-btn-'+openMonthIdx);
      if(pb){ pb.textContent='+'; pb.classList.remove('open'); }
    }
    var det = document.getElementById('fc-det-'+idx);
    if(det){ det.classList.add('open'); }
    var btn = document.getElementById('fc-btn-'+idx);
    if(btn){ btn.textContent='-'; btn.classList.add('open'); }
    openMonthIdx = idx;
  }
}

function renderForecast(){
  var active = scenarioModels.filter(function(m){return m.active;});
  var totalMonthlyDelta = active.reduce(function(a,m){return a+m.monthlyDelta;}, 0);

  // Scenario overlay bar
  var statusBar = document.getElementById('fc-scenario-bar');
  if(statusBar){
    if(active.length>0){
      statusBar.style.display='block';
      statusBar.innerHTML = 'SCENARIO OVERLAY — '
        +active.map(function(m){return '<strong>'+m.name+'</strong>';}).join(' + ')
        +' — COMBINED: <strong>'+(totalMonthlyDelta>=0?'+':'')+totalMonthlyDelta.toFixed(0)+'/mo</strong>'
        +' &nbsp;|&nbsp; Projected months highlighted';
    } else { statusBar.style.display='none'; }
  }

  // Build rows
  var rows = BASE_MONTHS.map(function(m){
    var incItems = m.incomeItems ? m.incomeItems.slice() : [];
    var expItems = m.expenseItems ? m.expenseItems.slice() : [];
    var inc = incItems.reduce(function(a,i){return a+i.amt;}, 0);
    var exp = expItems.reduce(function(a,e){return a+e.amt;}, 0);

    if(m.status==='proj'){
      active.forEach(function(sc){
        if(sc.monthlyDelta>0) inc += sc.monthlyDelta;
        else exp -= sc.monthlyDelta;
      });
      futureExpenses.forEach(function(fe){
        if(fe.month-1===m.idx) exp += fe.amtUSD;
      });
    }
    return {label:m.label, idx:m.idx, status:m.status, income:inc, expenses:exp, net:inc-exp, base:m};
  });

  // Cumulative
  var cum=0;
  rows.forEach(function(r){ cum+=r.net; r.cum=cum; });

  // Stats
  var totalInc = rows.reduce(function(a,r){return a+r.income;},0);
  var totalExp = rows.reduce(function(a,r){return a+r.expenses;},0);
  var yearEnd  = rows[rows.length-1].cum;
  var avgNet   = yearEnd/12;
  var statEl   = document.getElementById('fc-stats');
  if(statEl){
    var yec = yearEnd>=0?'pos':'neg';
    statEl.innerHTML=
      '<div class="stat"><div class="stat-label">Year-End Balance</div><div class="stat-val '+yec+'">$'+yearEnd.toLocaleString(undefined,{maximumFractionDigits:0})+'</div>'+(active.length?'<div class="stat-sub" style="color:var(--acc)">Scenarios applied</div>':'')+'</div>'+
      '<div class="stat"><div class="stat-label">Total Income</div><div class="stat-val pos">$'+totalInc.toLocaleString()+'</div></div>'+
      '<div class="stat"><div class="stat-label">Total Expenses</div><div class="stat-val neg">$'+totalExp.toLocaleString()+'</div></div>'+
      '<div class="stat"><div class="stat-label">Avg Monthly Net</div><div class="stat-val acc">$'+Math.round(avgNet).toLocaleString()+'</div></div>';
  }

  // Future expense bar
  var feBar = document.getElementById('fc-future-bar');
  if(feBar){
    if(futureExpenses.length>0){
      feBar.style.display='block';
      var mnths=['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
      feBar.innerHTML='<div style="padding:10px 16px;background:var(--s2);border:1px solid var(--ln);border-left:2px solid var(--neg);font-family:var(--fm);font-size:10px;letter-spacing:.1em;color:var(--neg)">'+
        'FUTURE EXPENSES — '+futureExpenses.map(function(fe){
          return fe.desc.toUpperCase()+' $'+fe.amtUSD.toFixed(0)+' USD ('+mnths[fe.month-1]+')';
        }).join(' &nbsp;|&nbsp; ')+'</div>';
    } else { feBar.style.display='none'; }
  }

  // Table rows — each month row + a hidden expandable detail row
  var statusTags={actual:'<span class="tag tag-g">Actual</span>',current:'<span class="tag tag-y">Current</span>',proj:'<span class="tag tag-d">Proj.</span>'};
  var tbody = document.getElementById('fc-tbody');
  if(tbody){
    var html = '';
    rows.forEach(function(r){
      var nc = r.net>=0?'pos':'neg';
      var isModified = active.length>0 && r.status==='proj';
      var hasFE = futureExpenses.some(function(fe){return fe.month-1===r.idx;});
      var rowBg = isModified ? 'style="background:rgba(200,245,66,.025)"' : '';

      // Summary row
      html += '<tr '+rowBg+' style="cursor:pointer" onclick="toggleMonthDetail('+r.idx+')">'+
        '<td><button class="fc-expand-btn" id="fc-btn-'+r.idx+'" onclick="event.stopPropagation();toggleMonthDetail('+r.idx+')">+</button></td>'+
        '<td style="font-weight:'+(r.status==='actual'?'600':'400')+'">'+r.label+'</td>'+
        '<td>'+statusTags[r.status]+
          (isModified?'<span class="tag tag-d" style="margin-left:4px;font-size:8px">MOD</span>':'')+
          (hasFE?'<span class="tag tag-r" style="margin-left:4px;font-size:8px">FE</span>':'')+'</td>'+
        '<td style="font-family:var(--fm)'+(r.status==='proj'?';color:var(--mid)':'')+'">$'+r.income.toLocaleString()+'</td>'+
        '<td style="font-family:var(--fm)'+(hasFE?';color:var(--neg)':r.status==='proj'?';color:var(--mid)':'')+'">$'+r.expenses.toLocaleString()+'</td>'+
        '<td class="tr '+nc+'">'+(r.net>=0?'+':'')+r.net.toLocaleString(undefined,{maximumFractionDigits:0})+'</td>'+
        '<td class="tr gld">$'+r.cum.toLocaleString(undefined,{maximumFractionDigits:0})+'</td></tr>';

      // Expandable detail row (spans all columns)
      var detailHtml = buildRowDetail(r.base, r, active, hasFE);
      html += '<tr class="fc-detail-row"><td colspan="7"><div class="fc-detail" id="fc-det-'+r.idx+'">'+detailHtml+'</div></td></tr>';
    });
    tbody.innerHTML = html;
    var fcTitle = document.getElementById('fc-table-title');
    if(fcTitle) fcTitle.textContent = active.length>0 ? 'Monthly Projection — Scenarios Applied':'Monthly Projection — Click Row to Expand';
  }
}
function applyToForecast(){
  renderForecast();
  go('forecast',null,'Forecast');
}

// ── FUTURE EXPENSE ────────────────────────────────────────────────────────
function saveFutureExp(){
  var desc  = document.getElementById('fe-desc').value.trim();
  var amt   = parseFloat(document.getElementById('fe-amt').value);
  var cur   = document.getElementById('fe-cur').value;
  var month = parseInt(document.getElementById('fe-month').value);
  var type  = document.getElementById('fe-type').value;
  if(!desc||!amt||isNaN(amt)){document.getElementById('fe-desc').focus();return;}
  var c     = (cur==='home') ? userProfile.homeCurrency : cur;
  var amtUSD= toUSD(amt, c);
  futureExpenses.push({desc:desc, amt:amt, cur:c, amtUSD:amtUSD, month:month, recurring:type==='monthly'});
  renderForecast();
  document.getElementById('fe-desc').value='';
  document.getElementById('fe-amt').value='';
  document.getElementById('fe-preview').style.display='none';
  document.getElementById('fe-analysis').style.display='none';
  flash('fe-flash','m-future-exp');
}

// ── MODALS ────────────────────────────────────────────────────────────────
function openModal(id){document.getElementById(id).classList.add('open');document.body.style.overflow='hidden';}
function closeModal(id){document.getElementById(id).classList.remove('open');document.body.style.overflow='';}
function bgClose(e,id){if(e.target===document.getElementById(id))closeModal(id);}
function flash(id,mid){var el=document.getElementById(id);el.classList.add('on');setTimeout(function(){el.classList.remove('on');closeModal(mid);},900);}

// ── SAVE CASH ─────────────────────────────────────────────────────────────
function saveCash(){
  var desc=document.getElementById('c-desc').value.trim();
  var amt=parseFloat(document.getElementById('c-amt').value);
  if(!desc||!amt||isNaN(amt)){document.getElementById('c-desc').focus();return;}
  var d=new Date(document.getElementById('c-date').value);
  var ds=isNaN(d.getTime())?'TODAY':d.toLocaleDateString('en-US',{month:'short',day:'numeric'}).toUpperCase();
  var cur=document.getElementById('c-cur').value;
  var c=(cur==='home')?userProfile.homeCurrency:cur;
  var amtUSD=toUSD(amt, c);
  var curNote=c!=='USD'?' ('+c+' '+amt.toFixed(2)+' → $'+amtUSD.toFixed(2)+')':'';
  cashData.unshift({date:ds, desc:desc+curNote, cat:document.getElementById('c-cat').value,
    type:document.getElementById('c-type').value, dir:document.getElementById('c-dir').value, amt:amtUSD});
  renderCash();
  document.getElementById('c-desc').value='';document.getElementById('c-amt').value='';
  document.getElementById('c-fx-preview').style.display='none';
  flash('c-flash','m-cash');
}

// ── LOAN HELPERS ──────────────────────────────────────────────────────────
function loanCalc(bal,rate,term){
  var r=rate/100/12;if(r===0)return{mo:bal/term,months:term};
  var mo=bal*r*Math.pow(1+r,term)/(Math.pow(1+r,term)-1);
  var months=Math.ceil(-Math.log(1-bal*r/mo)/Math.log(1+r));
  return{mo:mo,months:months};
}
function loanPreview(){
  var bal=parseFloat(document.getElementById('l-bal').value);
  var rate=parseFloat(document.getElementById('l-rate').value);
  var term=parseInt(document.getElementById('l-term').value);
  var box=document.getElementById('l-preview');
  if(!bal||!rate||!term){box.classList.remove('on');return;}
  var lp=loanCalc(bal,rate,term);
  var d=new Date();d.setMonth(d.getMonth()+lp.months);
  var payoff=d.toLocaleDateString('en-US',{month:'short',year:'numeric'}).toUpperCase();
  var interest=Math.max(0,Math.round(lp.mo*lp.months-bal));
  box.classList.add('on');
  box.innerHTML='PAYOFF: <strong style="color:var(--gld)">'+payoff+'</strong> &nbsp; MONTHLY: <strong style="color:var(--txt)">$'+Math.round(lp.mo).toLocaleString()+'</strong> &nbsp; TOTAL INTEREST: <strong style="color:var(--neg)">$'+interest.toLocaleString()+'</strong>';
}
function saveLoan(){
  var name=document.getElementById('l-name').value.trim();
  var bal=parseFloat(document.getElementById('l-bal').value);
  var rate=parseFloat(document.getElementById('l-rate').value);
  var term=parseInt(document.getElementById('l-term').value);
  var orig=parseFloat(document.getElementById('l-orig').value)||bal;
  if(!name||!bal||!rate||!term){document.getElementById('l-name').focus();return;}
  var lp=loanCalc(bal,rate,term);
  var d=new Date();d.setMonth(d.getMonth()+lp.months);
  var payoff=d.toLocaleDateString('en-US',{month:'short',year:'numeric'});
  var pct=Math.max(0,Math.min(98,Math.round((1-bal/orig)*100)));
  var colors={M:'#60a5fa',A:'#4ade80',S:'#fbbf24',P:'#f87171',B:'#c8f542',O:'#94a3b8'};
  var t=document.getElementById('l-type').value;
  loanData.push({name:name,type:t,bal:bal,monthly:Math.round(lp.mo),rate:rate,payoff:payoff,pct:pct,color:colors[t]||'#94a3b8'});
  renderLoans();
  ['l-name','l-orig','l-bal','l-rate','l-term'].forEach(function(id){document.getElementById(id).value='';});
  document.getElementById('l-preview').classList.remove('on');
  flash('l-flash','m-loan');
}

// ── INVEST ────────────────────────────────────────────────────────────────
function invCalc(){
  var q=parseFloat(document.getElementById('i-qty').value);
  var p=parseFloat(document.getElementById('i-price').value);
  if(q&&p)document.getElementById('i-total').value=(q*p).toFixed(2);
}
function invCalcRev(){
  var t=parseFloat(document.getElementById('i-total').value);
  var p=parseFloat(document.getElementById('i-price').value);
  if(t&&p)document.getElementById('i-qty').value=(t/p).toFixed(4);
}
function saveInvest(){
  var ticker=document.getElementById('i-ticker').value.trim().toUpperCase();
  var total=parseFloat(document.getElementById('i-total').value);
  var qty=parseFloat(document.getElementById('i-qty').value)||0;
  if(!ticker||!total||isNaN(total)){document.getElementById('i-ticker').focus();return;}
  var dv=document.getElementById('i-date').value;
  var d=new Date(dv);var ds=isNaN(d.getTime())?'TODAY':d.toLocaleDateString('en-US',{month:'short',day:'numeric'}).toUpperCase();
  var cur=document.getElementById('i-cur').value;
  var c=(cur==='home')?userProfile.homeCurrency:cur;
  var totalUSD=toUSD(total,c);
  invData.unshift({date:ds,name:document.getElementById('i-notes').value||ticker,ticker:ticker,
    type:document.getElementById('i-type').value,action:document.getElementById('i-action').value,
    qty:qty,amt:totalUSD,origCur:c,origAmt:total});
  renderInvLog();
  ['i-ticker','i-qty','i-price','i-total','i-notes'].forEach(function(id){document.getElementById(id).value='';});
  document.getElementById('i-fx-preview').style.display='none';
  flash('i-flash','m-invest');
}

// ── CATEGORIES ────────────────────────────────────────────────────────────
function pickClr(el){
  document.querySelectorAll('.clr-swatch').forEach(function(c){c.classList.remove('on');});
  el.classList.add('on');selColor=el.getAttribute('data-c');
}
function saveCat(){
  var name=document.getElementById('k-name').value.trim();
  var budget=parseFloat(document.getElementById('k-budget').value);
  if(!name||!budget||isNaN(budget)){document.getElementById('k-name').focus();return;}
  catData.push({name:name,budget:budget,spent:0,color:selColor});
  renderCats();renderDashCats();
  document.getElementById('k-name').value='';document.getElementById('k-budget').value='';
  flash('k-flash','m-cat');
}

// ── NAVIGATION ────────────────────────────────────────────────────────────
function go(id,el,title){
  document.querySelectorAll('.pg').forEach(function(p){p.style.display='none';p.classList.remove('on');});
  document.querySelectorAll('.ni,.mnb').forEach(function(b){b.classList.remove('on');});
  var s=document.getElementById(id);
  if(s){s.style.display='block';s.classList.add('on');}
  if(el)el.classList.add('on');
  if(title)document.getElementById('mob-title').textContent=title.toUpperCase();
}
function scTab(id,el){
  ['sc-chat','sc-saved','sc-compare'].forEach(function(x){var e=document.getElementById(x);if(e)e.style.display='none';});
  var t=document.getElementById('sc-'+id);
  if(t) t.style.display=(id==='chat')?'flex':'block';
  document.querySelectorAll('#scenarios .tab').forEach(function(t){t.classList.remove('on');});
  if(el)el.classList.add('on');
  if(id==='saved') renderScCards();
  if(id==='compare') renderScCompare();
}
function invTab(id,el){
  ['inv-ov','inv-schw','inv-log'].forEach(function(x){var e=document.getElementById(x);if(e)e.style.display='none';});
  var t=document.getElementById('inv-'+id);
  if(t)t.style.display='block';
  document.querySelectorAll('#investments .tab').forEach(function(t){t.classList.remove('on');});
  if(el)el.classList.add('on');
}
function toggleMore(){document.getElementById('mdrawer').classList.toggle('open');document.getElementById('dov').classList.toggle('open');}
function closeMore(){document.getElementById('mdrawer').classList.remove('open');document.getElementById('dov').classList.remove('open');}

// ── CHAT ─────────────────────────────────────────────────────────────────
var chatReplies=[
  "Modeling against actuals:<br><br>Dining avg: <strong>$680/mo</strong>. 50% reduction frees <strong>$340/mo</strong>.<br><br>Applied as mortgage principal:<br>— Payoff: Nov 2046 → Oct 2042 <span style='color:var(--acc)'>(4 yr earlier)</span><br>— Interest saved: <strong>$38,400</strong><br>— FY2026 impact: <strong>+$4,080</strong>",
  "Mortgage analysis: <strong>$248,200 outstanding at 6.25% APR</strong>.<br><br>Extra $300/mo principal application:<br>— Interest saved: <strong>$41,200</strong><br>— Payoff advance: <strong>4 years</strong>",
  "Income scenario: <strong>+$1,500/mo gross</strong>.<br><br>Monthly net: <strong>$1,520 → $3,020</strong><br>Annual delta: <strong>+$18,000</strong><br>5-year accretion: <strong>+$90,000</strong>"
];
var chatIdx=0;
function sendMsg(){
  var inp=document.getElementById('chatinp');
  var box=document.getElementById('chatbox');
  var txt=inp.value.trim();if(!txt)return;inp.value='';
  var u=document.createElement('div');u.className='msg u';
  u.innerHTML='<div class="ava">JG</div><div class="bub u">'+txt+'</div>';
  box.appendChild(u);
  var t=document.createElement('div');t.className='msg';
  t.innerHTML='<div class="ava acc">AI</div><div class="bub a"><div style="display:flex;gap:4px">'+
    '<div style="width:5px;height:5px;border-radius:50%;background:var(--mid);animation:pulse 1.3s ease infinite"></div>'.repeat(3)+'</div></div>';
  box.appendChild(t);box.scrollTop=box.scrollHeight;
  setTimeout(function(){
    box.removeChild(t);
    var r=chatReplies[chatIdx%chatReplies.length];chatIdx++;
    var a=document.createElement('div');a.className='msg';
    a.innerHTML='<div class="ava acc">AI</div><div class="bub a">'+r+'<div class="scnote" style="margin-top:10px">MODEL SAVED — See Saved Models tab</div></div>';
    box.appendChild(a);box.scrollTop=box.scrollHeight;
  },1400);
}
document.addEventListener('keydown',function(e){
  if(e.target.id==='chatinp'&&e.key==='Enter'&&!e.shiftKey){e.preventDefault();sendMsg();}
});

// ── CSV ───────────────────────────────────────────────────────────────────
function downloadCSV(){
  var rows=[['Month','Income','Expenses','Net'],
    ['January 2025',7500,5820,1680],['February 2025',7500,4182,3318],
    ['March 2025',7500,6120,1380],['April 2025',7500,5980,1520],
    ['May 2025',7500,6200,1300],['June 2025',7500,5800,1700],
    ['July 2025',7500,5960,1540],['August 2025',7500,5960,1540],
    ['September 2025',7500,5960,1540],['October 2025',7500,5960,1540],
    ['November 2025',7500,5960,1540],['December 2025',7500,5960,1540]
  ];
  var csv=rows.map(function(r){return r.join(',');}).join('\n');
  var a=document.createElement('a');a.href='data:text/csv,'+encodeURIComponent(csv);
  a.download='arca-annual-report-2025.csv';a.click();
}


// ══════════════════════════════════════════════════════
//  HOUSEHOLD ENGINE
// ══════════════════════════════════════════════════════

var householdMembers = [
  { id:'jorge', name:'Jorge García', initials:'JG', color:'#dbeafe', textColor:'#1e40af', role:'Primary', active:true },
  { id:'maria', name:'María García', initials:'MG', color:'#fce7f3', textColor:'#9d174d', role:'Spouse',  active:false }
];
var activeHHMember = 'jorge';
var hhTxnFilter = 'all';

// Transactions per member
var hhTxns = {
  jorge: [
    {date:'FEB 22', desc:'Whole Foods Market',        cat:'Groceries',     amt:94.30,  dir:'-'},
    {date:'FEB 21', desc:'Salary Deposit',             cat:'Income',        amt:3750,   dir:'+'},
    {date:'FEB 20', desc:'Little Stars Daycare',       cat:'Childcare',     amt:600,    dir:'-'},
    {date:'FEB 18', desc:'Netflix',                    cat:'Entertainment', amt:15.99,  dir:'-'},
    {date:'FEB 15', desc:'Mortgage Payment',           cat:'Housing',       amt:1850,   dir:'-'},
    {date:'FEB 14', desc:'Shell — Fuel',               cat:'Transport',     amt:62.40,  dir:'-'},
    {date:'FEB 10', desc:'Robinhood — AAPL',           cat:'Investments',   amt:500,    dir:'-'}
  ],
  maria: [
    {date:'FEB 23', desc:'Yoga Studio — Monthly',     cat:'Health',        amt:85,     dir:'-'},
    {date:'FEB 22', desc:'Salary Deposit',             cat:'Income',        amt:3750,   dir:'+'},
    {date:'FEB 21', desc:'H&M — Clothing',             cat:'Clothing',      amt:124,    dir:'-'},
    {date:'FEB 19', desc:'Farmer\'s Market',           cat:'Groceries',     amt:56,     dir:'-'},
    {date:'FEB 17', desc:'School Supplies — Sofía',   cat:'Childcare',     amt:42,     dir:'-'},
    {date:'FEB 15', desc:'Starbucks',                  cat:'Dining Out',    amt:18.50,  dir:'-'},
    {date:'FEB 12', desc:'Amazon — Household items',  cat:'Home',          amt:78.40,  dir:'-'}
  ]
};

// Shared budgets
var hhBudgets = [
  {name:'Groceries',     limit:1000, jorge:94.30+56,  maria:56,   color:'#16a34a'},
  {name:'Childcare',     limit:1800, jorge:600,       maria:42,   color:'#d97706'},
  {name:'Dining Out',    limit:600,  jorge:34.50,     maria:18.50,color:'#dc2626'},
  {name:'Entertainment', limit:250,  jorge:15.99,     maria:0,    color:'#7c3aed'},
  {name:'Transport',     limit:500,  jorge:62.40,     maria:0,    color:'#2563eb'},
  {name:'Clothing',      limit:300,  jorge:0,         maria:124,  color:'#db2777'}
];

function renderSidebarHH() {
  var el = document.getElementById('sb-hh-members');
  if (!el) return;
  el.innerHTML = householdMembers.map(function(m) {
    var isActive = m.id === activeHHMember;
    return '<div class="hh-member'+(isActive?' active-user':'')+'" onclick="switchHHMember(\''+m.id+'\')">' +
      '<div class="hh-avatar" style="background:'+m.color+';color:'+m.textColor+'">'+m.initials+'</div>' +
      '<div><div class="hh-name">'+m.name.split(' ')[0]+'</div>' +
      '<div style="font-size:9.5px;color:var(--dim)">'+m.role+'</div></div>' +
      '</div>';
  }).join('');
}

function switchHHMember(id) {
  activeHHMember = id;
  var m = householdMembers.find(function(x){return x.id===id;});
  householdMembers.forEach(function(x){x.active = x.id===id;});
  // Update sidebar label
  if (m) {
    var lbl = document.getElementById('sb-user-label');
    if (lbl) lbl.textContent = m.name.split(' ').map(function(w){return w[0].toUpperCase()+w.slice(1);}).join(' ').toUpperCase() + ' / ' + m.role.toUpperCase();
  }
  renderSidebarHH();
  // Flash the sidebar
  var el = document.getElementById('sb-hh-members');
  if (el) { el.style.opacity='0.5'; setTimeout(function(){el.style.opacity='1';},200); }
}

function renderHousehold() {
  var view = 'merged';

  // Combined stats
  var allTxns = hhTxns.jorge.concat(hhTxns.maria);
  var totalIncome  = allTxns.filter(function(t){return t.dir==='+'}).reduce(function(a,t){return a+t.amt;},0);
  var totalExpense = allTxns.filter(function(t){return t.dir==='-'}).reduce(function(a,t){return a+t.amt;},0);
  var jorgeExp = hhTxns.jorge.filter(function(t){return t.dir==='-'}).reduce(function(a,t){return a+t.amt;},0);
  var mariaExp = hhTxns.maria.filter(function(t){return t.dir==='-'}).reduce(function(a,t){return a+t.amt;},0);

  var statsEl = document.getElementById('hh-stats');
  if (statsEl) {
    statsEl.innerHTML =
      '<div class="stat"><div class="stat-label">Combined Income</div><div class="stat-val pos">$'+totalIncome.toLocaleString(undefined,{minimumFractionDigits:0,maximumFractionDigits:0})+'</div><div class="stat-sub">Both salaries</div></div>'+
      '<div class="stat"><div class="stat-label">Combined Expenses</div><div class="stat-val neg">$'+totalExpense.toLocaleString(undefined,{minimumFractionDigits:2,maximumFractionDigits:2})+'</div><div class="stat-sub">All categories</div></div>'+
      '<div class="stat"><div class="stat-label">Jorge\'s Share</div><div class="stat-val" style="color:var(--acc)">$'+jorgeExp.toFixed(0)+'</div><div class="stat-sub">'+(totalExpense>0?Math.round(jorgeExp/totalExpense*100):0)+'% of household</div></div>'+
      '<div class="stat"><div class="stat-label">María\'s Share</div><div class="stat-val" style="color:#9d174d">$'+mariaExp.toFixed(0)+'</div><div class="stat-sub">'+(totalExpense>0?Math.round(mariaExp/totalExpense*100):0)+'% of household</div></div>';
  }

  // Contribution bar
  var allExp = hhTxns.jorge.concat(hhTxns.maria).filter(function(t){return t.dir==='-';});
  var jExp = hhTxns.jorge.filter(function(t){return t.dir==='-';}).reduce(function(a,t){return a+t.amt;},0);
  var mExp = hhTxns.maria.filter(function(t){return t.dir==='-';}).reduce(function(a,t){return a+t.amt;},0);
  var totalExp2 = jExp + mExp;
  var jPct = totalExp2 > 0 ? Math.round(jExp/totalExp2*100) : 50;
  var mPct = 100 - jPct;
  var fill = document.getElementById('hh-contrib-fill');
  if (fill) fill.innerHTML =
    '<div style="width:'+jPct+'%;background:#93c5fd;transition:width .4s ease"></div>'+
    '<div style="width:'+mPct+'%;background:#f9a8d4;transition:width .4s ease"></div>';
  var legend = document.getElementById('hh-contrib-legend');
  if (legend) legend.innerHTML =
    '<span><span style="display:inline-block;width:8px;height:8px;border-radius:50%;background:#93c5fd;margin-right:5px"></span>Jorge — $'+jExp.toFixed(0)+' ('+jPct+'%)</span>'+
    '<span><span style="display:inline-block;width:8px;height:8px;border-radius:50%;background:#f9a8d4;margin-right:5px"></span>María — $'+mExp.toFixed(0)+' ('+mPct+'%)</span>';

  // Filters
  var filtersEl = document.getElementById('hh-filters');
  if (filtersEl) {
    var filterHTML = '';
    [['all','All'],['jorge','Jorge'],['maria','María']].forEach(function(pair){
      var active = hhTxnFilter === pair[0];
      var style = 'padding:4px 12px;font-size:11px;font-weight:500;border-radius:20px;cursor:pointer;border:1px solid ' +
        (active ? 'var(--acc)' : 'var(--ln)') + ';background:' +
        (active ? 'var(--accL)' : 'transparent') + ';color:' +
        (active ? 'var(--acc)' : 'var(--mid)') + ';transition:all .12s';
      filterHTML += '<button id="hh-f-' + pair[0] + '" style="' + style + '" onclick="hhFilterMember(\'' + pair[0] + '\')">' + pair[1] + '</button>';
    });
    filtersEl.innerHTML = filterHTML;
  }
    renderHHMerged();
}

function memberPill(m, isActive) {
  return '<button onclick="switchHHMember(\''+m.id+'\')" style="display:inline-flex;align-items:center;gap:7px;padding:5px 12px;border-radius:20px;border:1px solid '+(isActive?'var(--acc)':'var(--ln)')+';background:'+(isActive?'var(--accL)':'var(--s1)')+';cursor:pointer;font-size:12px;font-weight:'+(isActive?'500':'400')+';color:'+(isActive?'var(--acc)':'var(--txt2)')+';transition:all .12s">'+
    '<span style="width:18px;height:18px;border-radius:50%;background:'+m.color+';color:'+m.textColor+';display:inline-flex;align-items:center;justify-content:center;font-size:8px;font-weight:700">'+m.initials+'</span>'+
    m.name.split(' ')[0]+'</button>';
}

function renderHHMemberPills() {
  var el = document.getElementById('hh-member-pills');
  if (!el) return;
  el.innerHTML = householdMembers.map(function(m){
    return memberPill(m, m.id===activeHHMember);
  }).join('');
}

function hhFilterMember(who) {
  hhTxnFilter = who;
  renderHousehold();
}

function renderHHTxnRow(t, memberColor, memberInitials) {
  var c = t.dir==='+' ? 'var(--pos)' : 'var(--neg)';
  var s = t.dir==='+' ? '+' : '−';
  return '<div class="rrow" style="align-items:center">'+
    '<div style="width:24px;height:24px;border-radius:50%;background:'+memberColor.bg+';color:'+memberColor.text+';display:flex;align-items:center;justify-content:center;font-size:8px;font-weight:700;flex-shrink:0;margin-right:10px">'+memberInitials+'</div>'+
    '<div class="rrow-l"><div class="rrow-name">'+t.desc+'</div>'+
    '<div class="rrow-sub"><span>'+t.date+'</span><span>'+t.cat+'</span></div></div>'+
    '<div class="rrow-r"><div class="rrow-amt" style="color:'+c+'">'+s+'$'+t.amt.toFixed(2)+'</div></div></div>';
}

function renderHHMerged() {
  var el = document.getElementById('hh-txn-list');
  if (!el) return;
  var memberColors = {
    jorge: {bg:'#dbeafe', text:'#1e40af'},
    maria: {bg:'#fce7f3', text:'#9d174d'}
  };
  var memberInits = {jorge:'JG', maria:'MG'};

  // Build combined + sorted
  var merged = [];
  if (hhTxnFilter==='all' || hhTxnFilter==='jorge')
    hhTxns.jorge.forEach(function(t){ merged.push({t:t, who:'jorge'}); });
  if (hhTxnFilter==='all' || hhTxnFilter==='maria')
    hhTxns.maria.forEach(function(t){ merged.push({t:t, who:'maria'}); });

  // Sort by date desc (simple — works with our FEB format)
  merged.sort(function(a,b){ return b.t.date.localeCompare(a.t.date); });

  el.innerHTML = merged.map(function(item){
    return renderHHTxnRow(item.t, memberColors[item.who], memberInits[item.who]);
  }).join('') || '<div style="padding:20px;text-align:center;color:var(--dim);font-size:12px">No transactions</div>';
}

function renderHHSplit() {
  var elJ = document.getElementById('hh-jorge-list');
  var elM = document.getElementById('hh-maria-list');
  var totJ = document.getElementById('hh-jorge-total');
  var totM = document.getElementById('hh-maria-total');

  var jColor = {bg:'#dbeafe',text:'#1e40af'};
  var mColor = {bg:'#fce7f3',text:'#9d174d'};

  if (elJ) elJ.innerHTML = hhTxns.jorge.map(function(t){return renderHHTxnRow(t,jColor,'JG');}).join('');
  if (elM) elM.innerHTML = hhTxns.maria.map(function(t){return renderHHTxnRow(t,mColor,'MG');}).join('');

  var jExp = hhTxns.jorge.filter(function(t){return t.dir==='-';}).reduce(function(a,t){return a+t.amt;},0);
  var mExp = hhTxns.maria.filter(function(t){return t.dir==='-';}).reduce(function(a,t){return a+t.amt;},0);
  if (totJ) totJ.textContent = '-$'+jExp.toFixed(2);
  if (totM) totM.textContent = '-$'+mExp.toFixed(2);
}

function renderHHBudgets() {
  var el = document.getElementById('hh-budget-list');
  if (!el) return;
  el.innerHTML = hhBudgets.map(function(b){
    var totalSpent = b.jorge + b.maria;
    var pct = Math.min(100, Math.round(totalSpent / b.limit * 100));
    var over = totalSpent > b.limit;
    var jPct = b.limit > 0 ? Math.round(b.jorge/b.limit*100) : 0;
    var mPct = b.limit > 0 ? Math.round(b.maria/b.limit*100) : 0;
    return '<div class="hh-card" style="padding:18px 22px">'+
      '<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px">'+
        '<div style="font-weight:500;font-size:14px;color:var(--txt)">'+b.name+'</div>'+
        '<div style="display:flex;gap:10px;align-items:center">'+
          '<span style="font-size:11px;color:var(--mid)">Budget: $'+b.limit.toLocaleString()+'</span>'+
          '<span class="tag '+(over?'tag-r':'tag-g')+'">'+(over?'Over':'On track')+'</span>'+
        '</div>'+
      '</div>'+
      // Stacked bar
      '<div style="height:8px;background:var(--s3);border-radius:4px;overflow:hidden;margin-bottom:8px;display:flex">'+
        '<div style="width:'+jPct+'%;background:#93c5fd;border-radius:4px 0 0 4px"></div>'+
        '<div style="width:'+mPct+'%;background:#f9a8d4"></div>'+
      '</div>'+
      '<div style="display:flex;justify-content:space-between;font-size:11.5px">'+
        '<div style="display:flex;gap:14px">'+
          '<span><span style="display:inline-block;width:8px;height:8px;border-radius:50%;background:#93c5fd;margin-right:4px"></span>Jorge $'+b.jorge.toFixed(0)+'</span>'+
          '<span><span style="display:inline-block;width:8px;height:8px;border-radius:50%;background:#f9a8d4;margin-right:4px"></span>María $'+b.maria.toFixed(0)+'</span>'+
        '</div>'+
        '<span style="font-weight:600;color:'+(over?'var(--neg)':'var(--pos)')+'">$'+totalSpent.toFixed(0)+' / $'+b.limit.toLocaleString()+'</span>'+
      '</div>'+
    '</div>';
  }).join('');
}

function sendInvite() {
  var name = (document.getElementById('inv-name')||{}).value.trim();
  var email = (document.getElementById('inv-email')||{}).value.trim();
  if (!name || !email) { document.getElementById('inv-name').focus(); return; }
  flash('inv-flash', 'm-invite');
}



// ══════════════════════════════════════════════════════════════════
//  UPLOAD LOG
// ══════════════════════════════════════════════════════════════════
var uploadLog = [
  { id:1, filename:'chase_jan_2026.csv',  user:'Jorge García', date:'2026-01-28 09:14', rows:87,  status:'ok' },
  { id:2, filename:'amex_dec_2025.csv',   user:'Jorge García', date:'2026-01-15 14:32', rows:112, status:'ok' },
  { id:3, filename:'visa_nov_2025.xlsx',  user:'María García', date:'2025-12-04 11:07', rows:64,  status:'error', note:'3 unrecognised categories — review needed' },
  { id:4, filename:'chase_oct_2025.csv',  user:'Jorge García', date:'2025-11-02 08:55', rows:93,  status:'ok' }
];
var uploadLogNextId = 5;

function renderUploadLog() {
  var tbody = document.getElementById('upload-log-body');
  if (!tbody) return;
  if (uploadLog.length === 0) {
    tbody.innerHTML = '<tr><td colspan="6" style="text-align:center;padding:40px;color:var(--dim);font-size:13px">No files uploaded yet — drag a CSV or XLSX above to get started.</td></tr>';
    var sumEl = document.getElementById('ul-log-summary');
    if (sumEl) sumEl.textContent = '0 files tracked';
    return;
  }
  tbody.innerHTML = uploadLog.map(function(f) {
    var isMaria = f.user.indexOf('Mar') !== -1;
    var avBg = isMaria ? '#fce7f3' : '#dbeafe';
    var avTc = isMaria ? '#9d174d' : '#1e40af';
    var initials = f.user.split(' ').map(function(w){return w[0];}).join('').slice(0,2).toUpperCase();
    var flagged = f.flagged || false;
    var statusTag = flagged
      ? '<span class="tag tag-y">Flagged</span>'
      : (f.status === 'ok' ? '<span class="tag tag-g">Imported</span>' : '<span class="tag tag-r">Review needed</span>');
    var flagLabel = flagged ? 'Unflag' : 'Flag';
    var rowClass  = flagged ? 'ul-row-flagged' : '';
    var noteHtml  = f.note ? '<div style="font-size:10.5px;color:var(--neg);margin-top:3px">' + f.note + '</div>' : '';
    if (flagged && !f.note) noteHtml = '<div style="font-size:10.5px;color:var(--gld);margin-top:3px">Marked as potentially incorrect</div>';

    // Main data row
    var mainRow = '<tr class="' + rowClass + '" id="ul-row-' + f.id + '">' +
      '<td><div class="ul-fname" style="font-weight:500;color:var(--txt)">' + f.filename + '</div>' + noteHtml + '</td>' +
      '<td><div style="display:flex;align-items:center;gap:8px">' +
        '<div style="width:24px;height:24px;border-radius:50%;background:' + avBg + ';color:' + avTc + ';display:flex;align-items:center;justify-content:center;font-size:9px;font-weight:700;flex-shrink:0">' + initials + '</div>' +
        '<span style="font-size:12.5px;color:var(--txt2)">' + f.user + '</span>' +
      '</div></td>' +
      '<td style="color:var(--txt2);font-size:12px;white-space:nowrap">' + f.date + '</td>' +
      '<td style="color:var(--txt2);font-size:12px">' + f.rows + ' rows</td>' +
      '<td>' + statusTag + '</td>' +
      '<td style="text-align:right">' +
        '<button class="ul-flag-btn' + (flagged?' flagged':'') + '" onclick="flagUpload(' + f.id + ')" style="margin-right:6px">' + flagLabel + '</button>' +
        '<button onclick="confirmDeleteUpload(' + f.id + ')" style="padding:4px 10px;font-size:10.5px;font-weight:500;border-radius:3px;cursor:pointer;border:1px solid var(--neg);color:var(--neg);background:none">Delete</button>' +
      '</td>' +
    '</tr>';

    // Inline confirmation row (hidden by default)
    var confirmRow = '<tr class="ul-confirm" id="ul-confirm-' + f.id + '">' +
      '<td colspan="6">' +
        '<div style="display:flex;align-items:center;gap:12px;flex-wrap:wrap">' +
          '<span style="font-size:12.5px;color:var(--neg);font-weight:500">⚠ Delete <em>' + f.filename + '</em>?</span>' +
          '<span style="font-size:12px;color:var(--txt2)">The ' + f.rows + ' imported transactions will remain in your ledger and must be removed manually if needed.</span>' +
          '<div style="margin-left:auto;display:flex;gap:6px">' +
            '<button class="ul-del-btn ul-del-confirm" onclick="executeDeleteUpload(' + f.id + ')">Yes, delete record</button>' +
            '<button class="ul-del-btn ul-del-cancel" onclick="cancelDeleteUpload(' + f.id + ')">Cancel</button>' +
          '</div>' +
        '</div>' +
      '</td>' +
    '</tr>';

    return mainRow + confirmRow;
  }).join('');
  var sumEl2 = document.getElementById('ul-log-summary');
  if (sumEl2) sumEl2.textContent = uploadLog.length + ' file' + (uploadLog.length===1?'':'s') + ' tracked';
}

function confirmDeleteUpload(id) {
  // Close any other open confirm rows first
  uploadLog.forEach(function(f) {
    var c = document.getElementById('ul-confirm-' + f.id);
    if (c && f.id !== id) c.classList.remove('open');
  });
  var row = document.getElementById('ul-confirm-' + id);
  if (row) row.classList.toggle('open');
}

function cancelDeleteUpload(id) {
  var row = document.getElementById('ul-confirm-' + id);
  if (row) row.classList.remove('open');
}

function executeDeleteUpload(id) {
  var f = uploadLog.find(function(x){return x.id===id;});
  uploadLog = uploadLog.filter(function(x){ return x.id !== id; });
  renderUploadLog();
  // Show a brief notification
  var note = document.createElement('div');
  note.style.cssText = 'position:fixed;bottom:24px;left:50%;transform:translateX(-50%);background:var(--txt);color:#fff;padding:10px 18px;border-radius:4px;font-size:12px;z-index:9998;box-shadow:var(--shadow-md)';
  note.textContent = (f ? f.filename : 'File') + ' removed from upload log.';
  document.body.appendChild(note);
  setTimeout(function(){ note.remove(); }, 3000);
}

function flagUpload(id) {
  var f = uploadLog.find(function(x){return x.id===id;});
  if (f) f.flagged = !f.flagged;
  renderUploadLog();
}

function simulateUpload() {
  var names = ['chase_feb_2026.csv','visa_feb_2026.csv','amex_feb_2026.xlsx','citi_feb_2026.csv'];
  var name  = names[Math.floor(Math.random() * names.length)];
  var now   = new Date();
  var dateStr = now.getFullYear() + '-' +
    String(now.getMonth()+1).padStart(2,'0') + '-' +
    String(now.getDate()).padStart(2,'0') + ' ' +
    String(now.getHours()).padStart(2,'0') + ':' +
    String(now.getMinutes()).padStart(2,'0');
  uploadLog.unshift({
    id: uploadLogNextId++,
    filename: name,
    user: (userProfile.firstName || 'Jorge') + ' ' + (userProfile.lastName || 'García'),
    date: dateStr,
    rows: Math.floor(Math.random() * 80) + 30,
    status: 'ok'
  });
  renderUploadLog();
  var sumEl = document.getElementById('ul-log-summary');
  if (sumEl) sumEl.textContent = uploadLog.length + ' file' + (uploadLog.length===1?'':'s') + ' tracked · ' + uploadLog.filter(function(f){return f.flagged;}).length + ' flagged';
  var dz = document.querySelector('#upload .dz');
  if (dz) {
    var origBorder = dz.style.borderColor, origBg = dz.style.background;
    dz.style.borderColor = 'var(--pos)'; dz.style.background = 'var(--posL)';
    setTimeout(function(){ dz.style.borderColor = origBorder; dz.style.background = origBg; }, 1500);
  }
}

// ══════════════════════════════════════════════════════════════════
//  BILLING CYCLE ENGINE
// ══════════════════════════════════════════════════════════════════
var ccSettings = { closeDay:21, payDay:26, nickname:'Visa Rewards', incomeSource:'salary' };

var ccChargesThisCycle = [
  { date:'FEB 18', desc:'Netflix',            amt:15.99 },
  { date:'FEB 15', desc:'Shell — Fuel',        amt:62.40 },
  { date:'FEB 14', desc:'Whole Foods',          amt:94.30 },
  { date:'FEB 10', desc:'Amazon — Household',  amt:78.40 },
  { date:'FEB 08', desc:'Starbucks',            amt:18.50 },
  { date:'JAN 28', desc:'H&M',                 amt:124.00 },
  { date:'JAN 24', desc:'Yoga Studio Monthly', amt:85.00 }
];

function ccSuffix(n) {
  if (n===1||n===21||n===31) return 'st';
  if (n===2||n===22) return 'nd';
  if (n===3||n===23) return 'rd';
  return 'th';
}

function formatCycleDate(d) {
  var months=['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
  return months[d.getMonth()] + ' ' + d.getDate();
}

function getCycleRange(closeDay, refDate) {
  var d = refDate || new Date();
  var y = d.getFullYear(), m = d.getMonth();
  var closeThisMonth = new Date(y, m, closeDay);
  var cycleStart, cycleEnd, paymentDate;
  if (d <= closeThisMonth) {
    cycleStart   = new Date(y, m-1, closeDay+1);
    cycleEnd     = closeThisMonth;
    paymentDate  = new Date(y, m, ccSettings.payDay);
    if (paymentDate < cycleEnd) paymentDate = new Date(y, m+1, ccSettings.payDay);
  } else {
    cycleStart  = new Date(y, m, closeDay+1);
    cycleEnd    = new Date(y, m+1, closeDay);
    paymentDate = new Date(y, m+1, ccSettings.payDay);
  }
  return { cycleStart:cycleStart, cycleEnd:cycleEnd, paymentDate:paymentDate };
}

function updateCycleExplain() {
  var closeDay = parseInt((document.getElementById('cc-close-day')||{}).value) || 21;
  var payDay   = parseInt((document.getElementById('cc-pay-day')||{}).value)   || 26;
  var nickname = (document.getElementById('cc-nickname')||{}).value || ccSettings.nickname;
  ccSettings.closeDay = closeDay; ccSettings.payDay = payDay; ccSettings.nickname = nickname;

  var prev = closeDay + 1;
  var ep = document.getElementById('cc-cycle-explain-prev');
  var ec = document.getElementById('cc-cycle-explain-close');
  var ey = document.getElementById('cc-cycle-explain-pay');
  if (ep) ep.textContent = prev + ccSuffix(prev);
  if (ec) ec.textContent = closeDay + ccSuffix(closeDay);
  if (ey) ey.textContent = payDay + ccSuffix(payDay);

  var today   = new Date(2026, 1, 24); // fixed for preview; production: new Date()
  var cycle   = getCycleRange(closeDay, today);
  var charged = ccChargesThisCycle.reduce(function(a,c){return a+c.amt;},0);

  // Days remaining in cycle
  var daysToClose  = Math.max(0, Math.round((cycle.cycleEnd - today) / 86400000));
  var cycleLenDays = Math.round((cycle.cycleEnd - cycle.cycleStart) / 86400000) + 1;
  var daysElapsed  = cycleLenDays - daysToClose;
  var pctElapsed   = Math.min(100, Math.round(daysElapsed / cycleLenDays * 100));
  var bufferDays   = payDay > closeDay ? payDay - closeDay : (30 - closeDay + payDay);

  // ── Visual timeline ───────────────────────────────────────────────
  var timelineEl = document.getElementById('cc-timeline-wrap');
  if (timelineEl) {
    var todayLabel = 'Today ' + today.getDate() + ccSuffix(today.getDate());
    timelineEl.innerHTML =
      '<div style="display:flex;align-items:flex-start;gap:0">' +

        // Node 1: Cycle opens
        '<div class="cc-tnode" style="color:var(--mid)">' +
          '<div class="cc-tnode-dot"></div>' +
          '<div class="cc-tnode-label" style="color:var(--mid)">Opens</div>' +
          '<div class="cc-tnode-date">' + formatCycleDate(cycle.cycleStart) + '</div>' +
        '</div>' +

        // Line segment 1 (elapsed)
        '<div style="flex:1;display:flex;flex-direction:column;align-items:center;position:relative;top:4px">' +
          '<div style="width:100%;height:2px;background:var(--s4);border-radius:1px;position:relative">' +
            '<div style="position:absolute;left:0;top:0;height:100%;width:' + pctElapsed + '%;background:var(--acc);border-radius:1px;transition:width .4s ease"></div>' +
          '</div>' +
          '<div style="margin-top:6px;font-size:9.5px;color:var(--acc);font-weight:500">' + (daysToClose > 0 ? daysToClose + 'd left' : 'closes today') + '</div>' +
        '</div>' +

        // Node 2: Cycle closes
        '<div class="cc-tnode" style="color:var(--neg)">' +
          '<div class="cc-tnode-dot" style="border-color:var(--neg)"></div>' +
          '<div class="cc-tnode-label" style="color:var(--neg)">Closes</div>' +
          '<div class="cc-tnode-date">' + closeDay + ccSuffix(closeDay) + '</div>' +
        '</div>' +

        // Line segment 2 (buffer gap)
        '<div style="flex:0 0 80px;display:flex;flex-direction:column;align-items:center;position:relative;top:4px">' +
          '<div style="width:100%;height:2px;background:var(--gldL);border:1px dashed var(--gld);border-radius:1px"></div>' +
          '<div style="margin-top:6px;font-size:9.5px;color:var(--gld);font-weight:500">' + bufferDays + 'd buffer</div>' +
        '</div>' +

        // Node 3: Paycheck / payment
        '<div class="cc-tnode" style="color:var(--pos)">' +
          '<div class="cc-tnode-dot" style="border-color:var(--pos)"></div>' +
          '<div class="cc-tnode-label" style="color:var(--pos)">Paycheck</div>' +
          '<div class="cc-tnode-date">' + payDay + ccSuffix(payDay) + '</div>' +
        '</div>' +

      '</div>';
  }

  // ── Stat cards ───────────────────────────────────────────────────
  var cardsEl = document.getElementById('cc-cycle-cards');
  if (cardsEl) {
    var cards = [
      { label:'Cycle period',    val: formatCycleDate(cycle.cycleStart) + ' – ' + formatCycleDate(cycle.cycleEnd), color:'var(--txt)' },
      { label:'Charged so far',  val: '$' + charged.toFixed(2), color:'var(--neg)' },
      { label:'Buffer days',     val: bufferDays + ' days', color: bufferDays >= 3 ? 'var(--pos)' : 'var(--neg)' }
    ];
    cardsEl.innerHTML = cards.map(function(card){
      return '<div class="cc-card">' +
        '<div class="cc-card-label">' + card.label + '</div>' +
        '<div class="cc-card-val" style="color:' + card.color + '">' + card.val + '</div>' +
      '</div>';
    }).join('');
  }

  // ── Cycle explanation ────────────────────────────────────────────
  var noteEl = document.getElementById('cc-cycle-note');
  if (noteEl) {
    noteEl.innerHTML =
      'Charges accumulate from <strong>' + formatCycleDate(cycle.cycleStart) + '</strong> through <strong>' + formatCycleDate(cycle.cycleEnd) + '</strong>. ' +
      'Your statement closes on the <strong>' + closeDay + ccSuffix(closeDay) + '</strong> and you have <strong>' + bufferDays + ' days</strong> before your paycheck covers it on the <strong>' + payDay + ccSuffix(payDay) + '</strong>. ' +
      (daysToClose > 0 ? 'You have <strong>' + daysToClose + ' days</strong> left in the current cycle.' : '<strong>Today is cycle close day</strong> — statement is being finalized.');
  }

  // ── How Arca uses this ───────────────────────────────────────────
  var arcaNoteEl = document.getElementById('cc-arca-note');
  if (arcaNoteEl) {
    arcaNoteEl.innerHTML =
      'Transactions dated between the <strong>' + (closeDay+1) + ccSuffix(closeDay+1) + ' and ' + closeDay + ccSuffix(closeDay) + '</strong> are grouped together as one billing period. ' +
      'In the <strong>Forecast</strong>, your card payment of ~$' + charged.toFixed(0) + ' is scheduled as a cash outflow on the <strong>' + payDay + ccSuffix(payDay) + '</strong>, ' +
      'keeping your monthly net calculation accurate even when statement dates cross calendar month boundaries. ' +
      'Your <strong>' + bufferDays + '-day buffer</strong> means ' + (bufferDays >= 5
        ? 'you are in a comfortable position — paycheck arrives before the payment is due.'
        : 'timing is tight — consider moving your payment date later if possible.');
  }

  updateCycleBanner();
}

function updateCycleBanner() {
  var today   = new Date(2026, 1, 24);
  var cycle   = getCycleRange(ccSettings.closeDay, today);
  var charged = ccChargesThisCycle.reduce(function(a,c){return a+c.amt;},0);
  var daysToClose = Math.max(0, Math.round((cycle.cycleEnd - today) / 86400000));

  var nameEl  = document.getElementById('cc-banner-cycle-name');
  var datesEl = document.getElementById('cc-banner-cycle-dates');
  var chgEl   = document.getElementById('cc-banner-charged');
  var dueEl   = document.getElementById('cc-banner-due-date');
  var daysEl  = document.getElementById('cc-banner-days');
  if (nameEl)  nameEl.textContent  = ccSettings.nickname + ' — Current Cycle';
  if (datesEl) datesEl.textContent = formatCycleDate(cycle.cycleStart) + ' → ' + formatCycleDate(cycle.cycleEnd);
  if (chgEl)   chgEl.textContent   = '$' + charged.toFixed(2);
  if (dueEl)   dueEl.textContent   = formatCycleDate(cycle.paymentDate);
  if (daysEl)  daysEl.textContent  = daysToClose + 'd left';
}

// ── INIT ──────────────────────────────────────────────────────────────────
try {
var today=new Date().toISOString().split('T')[0];
['c-date','i-date'].forEach(function(id){var el=document.getElementById(id);if(el)el.value=today;});
renderCash();renderTxns();renderLoans();renderInvLog();renderCats();renderDashCats();renderForecast();
renderUploadLog();
updateCycleExplain();
updateCycleBanner();
renderUploadLog();
updateCycleExplain();
updateCycleBanner();
// Fetch live exchange rate for default country (Guatemala / GTQ)
fetchExchangeRate();
renderSidebarHH();
renderHHMemberPills();
renderHousehold();
} catch(e) { console.error('Arca init error:', e); }

</script>
<!-- ══ INVITE MODAL ══ -->
<div class="mo" id="m-invite" onclick="bgClose(event,'m-invite')">
  <div class="mbox">
    <div class="mhd"><div class="mtitle">Invite Household Member</div><button class="mclose" onclick="closeModal('m-invite')">×</button></div>
    <div class="mbody">
      <div style="font-size:12px;color:var(--mid);margin-bottom:18px;line-height:1.6">Linked members share all financial data in real time — transactions, forecasts, scenarios, and budgets.</div>
      <div class="fgrp"><label class="flbl">Member Name</label><input class="finp" type="text" id="inv-name" placeholder="e.g. María García"></div>
      <div class="fgrp"><label class="flbl">Email Address</label><input class="finp" type="email" id="inv-email" placeholder="maria@example.com"></div>
      <div class="fgrp"><label class="flbl">Relationship</label>
        <select class="finp" id="inv-rel">
          <option value="spouse">Spouse / Partner</option>
          <option value="child">Child</option>
          <option value="parent">Parent</option>
          <option value="sibling">Sibling</option>
          <option value="other">Other</option>
        </select>
      </div>
      <div style="padding:12px 14px;background:var(--accL);border-left:2px solid var(--acc);font-size:11.5px;color:var(--acc);border-radius:0 3px 3px 0;margin-bottom:8px">
        They will receive an email invite and must create an Arca account to link.
      </div>
      <div class="flash" id="inv-flash" style="border-left-color:var(--pos);background:var(--posL);color:var(--pos)">Invite sent — they'll receive an email shortly</div>
    </div>
    <div class="mactions">
      <button class="btn btn-out" onclick="closeModal('m-invite')">Cancel</button>
      <button class="btn btn-acc" onclick="sendInvite()">Send Invite</button>
    </div>
  </div>
</div>

</body>
</html>